<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Space</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- HLS.js æ’­æ”¾å™¨ -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
    <!-- Video.js æ’­æ”¾å™¨ä½œä¸ºå¤‡é€‰ -->
    <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
    <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet">
    <!-- Video.js HLSæ’ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/@videojs/http-streaming@3.0.2/dist/videojs-http-streaming.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .tooltip {
                position: relative;
            }
            .tooltip::after {
                content: attr(data-tooltip);
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                padding: 4px 8px;
                background-color: rgba(0, 0, 0, 0.75);
                color: white;
                border-radius: 4px;
                font-size: 12px;
                white-space: nowrap;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.2s, transform 0.2s;
                z-index: 50;
            }
            .tooltip:hover::after {
                opacity: 1;
                transform: translateX(-50%) translateY(-4px);
            }
        }
        
        /* è§†é¢‘æ’­æ”¾å™¨æ ·å¼ä¼˜åŒ– */
        #videoPlayer {
            position: relative;
            overflow: hidden;
            background: #000;
        }

        #videoPlayer video {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain !important;
            max-width: 100% !important;
            max-height: 100% !important;
        }

        /* Video.jsæ’­æ”¾å™¨æ ·å¼ */
        .video-js {
            width: 100% !important;
            height: 100% !important;
        }

        .video-js .vjs-tech {
            object-fit: contain !important;
        }

        /* HLSé”™è¯¯æ ·å¼ */
        .hls-error {
            color: #dc2626;
            background-color: #fee2e2;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-dark">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-md sticky top-0 z-50 mb-4">
        <div class="w-full px-6 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fa fa-film text-primary text-2xl mr-2"></i>
                <h1 class="text-xl font-bold text-dark">Video Space</h1>
            </div>
            <div class="flex items-center">
                <button 
                    id="showInputBtn" 
                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all flex items-center"
                >
                    <i class="fa fa-plus mr-2"></i> æ·»åŠ è§†é¢‘
                </button>
            </div>
        </div>
    </nav>

    <!-- ç²˜è´´è§†é¢‘åœ°å€åŒºåŸŸ (é»˜è®¤éšè—) -->
    <section id="inputSection" class="bg-white rounded-xl shadow-lg p-4 mb-4 mx-2 hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold flex items-center">
                <i class="fa fa-paste text-primary mr-2"></i> ç²˜è´´è§†é¢‘åœ°å€
            </h2>
            <button 
                id="closeInputBtn" 
                class="text-gray-500 hover:text-gray-700 transition-colors"
            >
                <i class="fa fa-times text-xl"></i>
            </button>
        </div>
        <div class="mb-4">
            <textarea 
                id="videoUrls" 
                class="w-full h-40 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                placeholder="è¯·ç²˜è´´è§†é¢‘åœ°å€ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
ç¯çƒé’“é±¼å¤§å†’é™©
<b>ç¬¬01é›†</b>https://v.lzcdn25.com/share/934b535800b1cba8f96a5d72f72f1611
<b>ç¬¬02é›†</b>https://v.lzcdn25.com/share/598920e11d1eb2a49501d59fce5ecbb7
<b>ç¬¬03é›†</b>https://v.lzcdn25.com/share/d2a27e83d429f0dcae6b937cf440aeb1"
            ></textarea>
        </div>
        <div class="flex flex-wrap gap-3">
            <button 
                id="parseBtn" 
                class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all flex items-center"
            >
                <i class="fa fa-magic mr-2"></i> è§£æåœ°å€
            </button>
            <button 
                id="templateBtn" 
                class="px-6 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-all flex items-center"
            >
                <i class="fa fa-file-text mr-2"></i> è¾“å…¥æ¨¡æ¿
            </button>
            <button 
                id="clearBtn" 
                class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all flex items-center"
            >
                <i class="fa fa-trash mr-2"></i> æ¸…ç©ºè¾“å…¥
            </button>
        </div>
    </section>

    <!-- æ’­æ”¾åŒºåŸŸ -->
    <section id="playerContainer" class="bg-white rounded-xl shadow-lg p-4 mb-4 mx-2 hidden relative overflow-hidden" style="height: calc(100vh - 300px);">
        <button 
            id="closePlayerBtn" 
            class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition-colors z-10"
        >
            <i class="fa fa-times text-xl"></i>
        </button>
        <h2 class="text-lg font-semibold mb-3 flex items-center">
            <i class="fa fa-play-circle text-primary mr-2"></i> æ­£åœ¨æ’­æ”¾
        </h2>
        <div class="bg-black rounded-lg mb-3 overflow-hidden" style="height: 80%;">
            <div id="videoPlayer" class="rounded-lg overflow-hidden" style="position: relative; width: 100%; height: 100%;">
                <video
                    id="videoElement"
                    controls
                    preload="auto"
                    crossorigin="anonymous"
                    playsinline
                    style="width: 100%; height: 100%;"
                >
                    <p class="vjs-no-js">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ï¼Œè¯· 
                        <a href="https://videojs.com/html5-video-support/" target="_blank">å‡çº§æµè§ˆå™¨</a>ã€‚
                    </p>
                </video>
            </div>
        </div>
        <div class="flex flex-wrap gap-3">
            <button 
                id="saveProgressBtn" 
                class="px-6 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-all flex items-center"
                disabled
            >
                <i class="fa fa-save mr-2"></i> ä¿å­˜è¿›åº¦
            </button>
            <button 
                id="screenshotBtn" 
                class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all flex items-center"
                disabled
            >
                <i class="fa fa-camera mr-2"></i> æˆªå›¾
            </button>
            <button 
                id="downloadScreenshotBtn" 
                class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all flex items-center hidden"
            >
                <i class="fa fa-download mr-2"></i> ä¸‹è½½æˆªå›¾
            </button>
        </div>
        <div id="screenshotContainer" class="mt-4 hidden">
            <h3 class="font-medium mb-2">æˆªå›¾é¢„è§ˆ</h3>
            <div class="bg-gray-100 rounded-lg p-4">
                <img id="screenshotImage" class="max-w-full rounded" alt="è§†é¢‘æˆªå›¾">
            </div>
        </div>
    </section>

    <!-- è§†é¢‘åˆ—è¡¨åŒºåŸŸ -->
    <section class="mb-4 mx-8">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fa fa-th-large text-primary mr-2"></i> æˆ‘çš„è§†é¢‘åˆ—è¡¨
        </h2>
        <div id="videoList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- è§†é¢‘å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            <div class="text-center text-gray-500 py-12 col-span-full">
                <i class="fa fa-film text-5xl mb-4 opacity-30"></i>
                <p>æš‚æ— è§†é¢‘ï¼Œè¯·æ·»åŠ è§†é¢‘</p>
            </div>
        </div>
    </section>

    <!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div id="confirmDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4" id="dialogTitle">ç¡®è®¤åˆ é™¤</h3>
            <p class="mb-6 text-gray-600" id="dialogMessage">ä½ ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§†é¢‘å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDialog" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">
                    å–æ¶ˆ
                </button>
                <button id="confirmDialogBtn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all">
                    ç¡®è®¤åˆ é™¤
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentVideo = null;
        let currentEpisode = null;
        let videoToDelete = null;
        let videoPlayer = null; // Video.js æ’­æ”¾å™¨å®ä¾‹
        let hlsInstance = null; // HLS.js å®ä¾‹
        let hasJumpedToProgress = false; // é˜²æ­¢é‡å¤è·³è½¬æ ‡å¿—

        // DOM åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            // ä» localStorage åŠ è½½ä¿å­˜çš„è§†é¢‘
            loadVideos();

            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            document.getElementById('showInputBtn').addEventListener('click', showInputSection);
            document.getElementById('closeInputBtn').addEventListener('click', hideInputSection);
            document.getElementById('parseBtn').addEventListener('click', parseVideoUrls);
            document.getElementById('templateBtn').addEventListener('click', insertTemplate);
            document.getElementById('clearBtn').addEventListener('click', clearInput);
            document.getElementById('screenshotBtn').addEventListener('click', takeScreenshot);
            document.getElementById('downloadScreenshotBtn').addEventListener('click', downloadScreenshot);
            document.getElementById('cancelDialog').addEventListener('click', hideConfirmDialog);
            document.getElementById('confirmDialogBtn').addEventListener('click', confirmDeleteVideo);
            document.getElementById('closePlayerBtn').addEventListener('click', hidePlayerSection);
            document.getElementById('saveProgressBtn').addEventListener('click', saveProgressManually);
        });

        // æ˜¾ç¤ºç²˜è´´è§†é¢‘åœ°å€åŒºåŸŸ
        function showInputSection() {
            const inputSection = document.getElementById('inputSection');
            inputSection.classList.remove('hidden');
            document.getElementById('videoUrls').focus();
        }

        // éšè—ç²˜è´´è§†é¢‘åœ°å€åŒºåŸŸ
        function hideInputSection() {
            const inputSection = document.getElementById('inputSection');
            inputSection.classList.add('hidden');
        }

        // éšè—æ’­æ”¾åŒºåŸŸ
        function hidePlayerSection() {
            const playerContainer = document.getElementById('playerContainer');
            playerContainer.classList.add('hidden');
            
            // é”€æ¯HLSå®ä¾‹
            if (hlsInstance) {
                try {
                    hlsInstance.destroy();
                } catch (e) {
                    console.error('é”€æ¯HLSå®ä¾‹å¤±è´¥:', e);
                }
                hlsInstance = null;
            }
            
            // é”€æ¯Video.jsæ’­æ”¾å™¨å®ä¾‹
            if (videoPlayer) {
                try {
                    videoPlayer.dispose();
                } catch (e) {
                    console.error('é”€æ¯æ’­æ”¾å™¨å¤±è´¥:', e);
                }
                videoPlayer = null;
            }
            
            // é‡ç½®videoå…ƒç´ 
            const videoElement = document.getElementById('videoElement');
            if (videoElement) {
                videoElement.src = '';
                videoElement.load();
            }
            
            // ç¦ç”¨æŒ‰é’®
            document.getElementById('screenshotBtn').disabled = true;
            document.getElementById('saveProgressBtn').disabled = true;
            
            // éšè—ä¸‹è½½æˆªå›¾æŒ‰é’®
            document.getElementById('downloadScreenshotBtn').classList.add('hidden');
        }

        // è§£æè§†é¢‘åœ°å€
        async function parseVideoUrls() {
            const input = document.getElementById('videoUrls').value.trim();
            if (!input) {
                showToast('è¯·è¾“å…¥è§†é¢‘åœ°å€', 'error');
                return;
            }

            try {
                showToast('æ­£åœ¨è§£æå¹¶éªŒè¯è§†é¢‘åœ°å€...', 'info');
                const videoData = parseVideoData(input);
                
                // éªŒè¯æ‰€æœ‰è§†é¢‘URLæ˜¯å¦å¯è®¿é—®
                const checkResults = await Promise.allSettled(
                    videoData.episodes.map(episode => checkVideoUrl(episode.url))
                );
                
                // ç»Ÿè®¡éªŒè¯ç»“æœ
                let successCount = 0;
                let failedUrls = [];
                
                checkResults.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value.accessible) {
                        successCount++;
                    } else {
                        failedUrls.push({
                            title: videoData.episodes[index].title,
                            url: videoData.episodes[index].url
                        });
                    }
                });
                
                // å¦‚æœæœ‰éƒ¨åˆ†URLæ— æ³•è®¿é—®ï¼Œç»™å‡ºè­¦å‘Šä½†ä»ç„¶ä¿å­˜
                if (failedUrls.length > 0 && successCount > 0) {
                    showToast(`è§£æå®Œæˆï¼Œ${successCount}ä¸ªè§†é¢‘å¯è®¿é—®ï¼Œ${failedUrls.length}ä¸ªè§†é¢‘å¯èƒ½æ— æ³•æ’­æ”¾`, 'warning');
                    console.warn('æ— æ³•è®¿é—®çš„è§†é¢‘:', failedUrls);
                } else if (failedUrls.length === videoData.episodes.length) {
                    showToast('è­¦å‘Šï¼šæ‰€æœ‰è§†é¢‘URLéƒ½å¯èƒ½æ— æ³•è®¿é—®ï¼Œä½†å·²ä¿å­˜åˆ°åˆ—è¡¨', 'warning');
                } else {
                    showToast('è§†é¢‘å·²æˆåŠŸæ·»åŠ ï¼Œæ‰€æœ‰é“¾æ¥éªŒè¯é€šè¿‡', 'success');
                }
                
                saveVideo(videoData);
                loadVideos();
                hideInputSection();
                clearInput();
            } catch (error) {
                showToast('è§£æå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ£€æŸ¥è§†é¢‘URLæ˜¯å¦å¯è®¿é—®
        async function checkVideoUrl(url) {
            try {
                const response = await fetch('/check-video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('æ£€æŸ¥è§†é¢‘URLå¤±è´¥:', error);
                return { accessible: false, error: error.message };
            }
        }

        // è§£æè§†é¢‘æ•°æ®
        function parseVideoData(input) {
            const lines = input.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) {
                throw new Error('è¾“å…¥æ ¼å¼ä¸æ­£ç¡®ï¼Œè‡³å°‘éœ€è¦è§†é¢‘åç§°å’Œä¸€ä¸ªè§†é¢‘åœ°å€');
            }

            const title = lines[0].trim();
            const episodes = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… <b>æ ‡ç­¾å†…å®¹</b>URL çš„æ ¼å¼
                const regex = /<b>(.*?)<\/b>(.*)/;
                const match = line.match(regex);
                
                if (match && match.length === 3) {
                    const episodeTitle = match[1].trim();
                    const url = match[2].trim();
                    
                    if (isValidUrl(url)) {
                        episodes.push({
                            id: `ep${i}`,
                            title: episodeTitle,
                            url: url
                        });
                    } else {
                        throw new Error(`ç¬¬ ${i} è¡Œçš„URLæ ¼å¼ä¸æ­£ç¡®: ${url}`);
                    }
                } else {
                    throw new Error(`ç¬¬ ${i} è¡Œæ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ç¬¦åˆ <b>é›†æ•°</b>URL æ ¼å¼`);
                }
            }

            if (episodes.length === 0) {
                throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„è§†é¢‘åœ°å€');
            }

            return {
                id: generateId(),
                title: title,
                episodes: episodes
            };
        }

        // éªŒè¯URLæ ¼å¼
        function isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch (error) {
                return false;
            }
        }

        // ç”Ÿæˆå”¯ä¸€ID
        function generateId() {
            return 'vid_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
        }

        // ä¿å­˜å•ä¸ªè§†é¢‘åˆ°localStorage
        function saveVideo(videoData) {
            const savedVideos = JSON.parse(localStorage.getItem('videoPlaylists') || '[]');
            savedVideos.push(videoData);
            localStorage.setItem('videoPlaylists', JSON.stringify(savedVideos));
        }

        // ä»localStorageåŠ è½½è§†é¢‘æ•°æ®
        function loadVideos() {
            const savedVideos = localStorage.getItem('videoPlaylists');
            
            if (savedVideos) {
                try {
                    const videos = JSON.parse(savedVideos);
                    const videoList = document.getElementById('videoList');
                    videoList.innerHTML = '';
                    
                    if (videos.length > 0) {
                        videos.forEach(video => {
                            const videoCard = createVideoCard(video);
                            videoList.appendChild(videoCard);
                        });
                    } else {
                        videoList.innerHTML = `
                            <div class="text-center text-gray-500 py-12 col-span-full">
                                <i class="fa fa-film text-5xl mb-4 opacity-30"></i>
                                <p>æš‚æ— è§†é¢‘ï¼Œè¯·æ·»åŠ è§†é¢‘</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('åŠ è½½è§†é¢‘åˆ—è¡¨å¤±è´¥:', error);
                    localStorage.removeItem('videoPlaylists');
                }
            }
        }

        // åˆ›å»ºè§†é¢‘å¡ç‰‡
        function createVideoCard(videoData) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg overflow-hidden card-shadow card-hover';
            card.dataset.videoId = videoData.id;

            card.innerHTML = `
                <div class="p-5 relative">
                    <button class="delete-video absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors" title="åˆ é™¤è§†é¢‘">
                        <i class="fa fa-times-circle text-xl"></i>
                    </button>
                    <h3 class="font-bold text-lg mb-3 truncate">${escapeHTML(videoData.title)}</h3>
                    <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                        <div class="flex items-center">
                            <i class="fa fa-film mr-2"></i>
                            <span>${videoData.episodes.length} é›†</span>
                        </div>
                        <div class="text-xs text-primary" id="latest-progress-${videoData.id}">
                            ${getLatestProgressDisplay(videoData)}
                        </div>
                    </div>
                    <button class="toggle-episodes w-full py-2 px-4 bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200 transition-all flex justify-center items-center">
                        <span>æŸ¥çœ‹å…¨éƒ¨å‰§é›†</span>
                        <i class="fa fa-chevron-down ml-2 transition-transform duration-300"></i>
                    </button>
                    <div class="episodes-container mt-4 hidden">
                        <div class="grid grid-cols-2 gap-2">
                            ${videoData.episodes.map(episode => {
                                const progress = getSavedProgress(videoData.id, episode.id);
                                const progressDisplay = progress > 0 ? ` (å·²è§‚çœ‹ ${formatTime(progress)})` : '';
                                return `
                                    <div class="flex gap-1">
                                        <button 
                                            class="play-episode flex-1 py-2 px-3 bg-primary/10 text-primary rounded hover:bg-primary/20 transition-all text-sm truncate relative group"
                                            data-episode-id="${episode.id}"
                                            data-url="${episode.url}"
                                        >
                                            ${escapeHTML(episode.title)}${progressDisplay}
                                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-20">
                                                ${escapeHTML(episode.title)}${progressDisplay}
                                            </div>
                                        </button>
                                        <button class="copy-url px-2 py-2 text-gray-400 hover:text-primary transition-colors relative group" title="å¤åˆ¶é“¾æ¥" data-url="${episode.url}">
                                            <i class="fa fa-link"></i>
                                            <div class="absolute bottom-full right-0 mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-10">
                                                ${episode.url.length > 40 ? episode.url.substring(0, 40) + '...' : episode.url}
                                            </div>
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;

            // ç»‘å®šå±•å¼€/æŠ˜å äº‹ä»¶
            const toggleBtn = card.querySelector('.toggle-episodes');
            const episodesContainer = card.querySelector('.episodes-container');
            const chevron = toggleBtn.querySelector('.fa-chevron-down');

            toggleBtn.addEventListener('click', () => {
                episodesContainer.classList.toggle('hidden');
                chevron.style.transform = episodesContainer.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
            });

            // ç»‘å®šæ’­æ”¾äº‹ä»¶
            const playButtons = card.querySelectorAll('.play-episode');
            playButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const episodeId = e.currentTarget.dataset.episodeId;
                    const episode = videoData.episodes.find(ep => ep.id === episodeId);
                    if (episode) {
                        playVideo(videoData.id, videoData.title, episode);
                    }
                });
            });

            // ç»‘å®šå¤åˆ¶é“¾æ¥äº‹ä»¶
            const copyButtons = card.querySelectorAll('.copy-url');
            copyButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const url = e.currentTarget.dataset.url;
                    copyToClipboard(url);
                    e.stopPropagation(); // é˜²æ­¢è§¦å‘æ’­æ”¾äº‹ä»¶
                });
            });

            // ç»‘å®šåˆ é™¤äº‹ä»¶
            const deleteBtn = card.querySelector('.delete-video');
            deleteBtn.addEventListener('click', (e) => {
                videoToDelete = videoData.id;
                showConfirmDialog(`ç¡®å®šè¦åˆ é™¤ã€Š${videoData.title}ã€‹å—ï¼Ÿ`, 'ç¡®è®¤åˆ é™¤');
                e.stopPropagation(); // é˜²æ­¢è§¦å‘å±•å¼€/æŠ˜å äº‹ä»¶
            });

            return card;
        }

        // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
        function escapeHTML(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // æ’­æ”¾è§†é¢‘
        function playVideo(videoId, videoTitle, episode) {
            currentVideo = { id: videoId, title: videoTitle };
            currentEpisode = episode;
            
            // æ˜¾ç¤ºæ’­æ”¾åŒºåŸŸ
            const playerContainer = document.getElementById('playerContainer');
            playerContainer.classList.remove('hidden');
            
            // æ›´æ–°æ ‡é¢˜
            document.title = `${episode.title} - Video Space`;
            
            // å¯ç”¨æŒ‰é’®
            document.getElementById('screenshotBtn').disabled = false;
            document.getElementById('saveProgressBtn').disabled = false;
            
            // å…ˆå°è¯•å†…åµŒæ’­æ”¾
            tryIframePlay(episode.url);
        }
        
        // æ˜¾ç¤ºHLSé”™è¯¯å¯¹è¯æ¡†
        function showHLSErrorDialog(episode, error) {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-red-600">
                        <i class="fa fa-exclamation-triangle mr-2"></i>HLSæµæ’­æ”¾é”™è¯¯
                    </h3>
                    <div class="mb-4 p-4 bg-red-50 rounded-lg">
                        <p class="text-sm text-gray-700 mb-2"><strong>é”™è¯¯ç±»å‹ï¼š</strong> ${error.errorType || 'HLSè§£æé”™è¯¯'}</p>
                        <p class="text-sm text-gray-700 mb-2"><strong>é”™è¯¯ä»£ç ï¼š</strong> ${error.errorCode || 'unknown'}</p>
                        ${error.errorDetails ? `<p class="text-sm text-gray-700 mb-2"><strong>è¯¦ç»†ä¿¡æ¯ï¼š</strong> ${error.errorDetails}</p>` : ''}
                        <p class="text-sm text-gray-700 mb-2"><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong> ${error.message || 'HLSæµæ— æ³•æ­£å¸¸è§£æ'}</p>
                        ${error.url ? `<p class="text-sm text-gray-700"><strong>å¤±è´¥URLï¼š</strong> <span class="text-xs break-all">${error.url}</span></p>` : ''}
                    </div>
                    <p class="mb-4 text-gray-600">è¿™æ˜¯ä¸€ä¸ªHLSæµåª’ä½“æ–‡ä»¶ï¼ˆ.m3u8ï¼‰ï¼Œå¯èƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p>
                    <ul class="text-sm text-gray-600 mb-4 list-disc list-inside space-y-1">
                        <li>è§†é¢‘æºæœåŠ¡å™¨æœ‰è®¿é—®é™åˆ¶</li>
                        <li>HLSæµæ ¼å¼ä¸å…¼å®¹æˆ–å·²æŸå</li>
                        <li>éœ€è¦ç‰¹æ®Šçš„æ’­æ”¾å™¨æ”¯æŒ</li>
                        <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
                    </ul>
                    <div class="space-y-3">
                        <button onclick="tryDirectHLSPlay('${episode.url}')" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center">
                            <i class="fa fa-refresh mr-2"></i> å°è¯•ç›´è¿æ’­æ”¾
                        </button>
                        <button onclick="openInNewTab('${episode.url}')" class="w-full px-4 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all flex items-center justify-center">
                            <i class="fa fa-external-link mr-2"></i> åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€
                        </button>
                        <button onclick="copyVideoUrl('${episode.url}')" class="w-full px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all flex items-center justify-center">
                            <i class="fa fa-copy mr-2"></i> å¤åˆ¶åŸå§‹é“¾æ¥
                        </button>
                    </div>
                    <div class="mt-4 pt-4 border-t">
                        <button onclick="closePlayOptions()" class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">
                            å…³é—­
                        </button>
                    </div>
                </div>
            `;
            dialog.id = 'playOptionsDialog';
            document.body.appendChild(dialog);
        }
        
        // å°è¯•ç›´è¿HLSæ’­æ”¾ï¼ˆä¸é€šè¿‡ä»£ç†ï¼‰
        function tryDirectHLSPlay(url) {
            try {
                closePlayOptions();
                
                // æ¸…ç†ä¹‹å‰çš„æ’­æ”¾å™¨å®ä¾‹
                cleanupPlayer();
                
                // é‡ç½®è·³è½¬æ ‡å¿—ä½
                hasJumpedToProgress = false;
                
                // è·å–ä¿å­˜çš„æ’­æ”¾è¿›åº¦
                const savedProgress = getSavedProgress(currentVideo.id, currentEpisode.id);
                
                showToast('æ­£åœ¨å°è¯•ç›´è¿HLSæ’­æ”¾...', 'info');
                
                // è·å–videoå…ƒç´ 
                const videoElement = document.getElementById('videoElement');
                
                // ç›´æ¥ä½¿ç”¨åŸå§‹URLï¼Œä¸é€šè¿‡ä»£ç†
                if (Hls.isSupported()) {
                    // ä½¿ç”¨hls.jsç›´è¿ï¼ˆä¸ä½¿ç”¨ä»£ç†ï¼‰
                    hlsInstance = new Hls({
                        enableWorker: true,
                        lowLatencyMode: false,
                        backBufferLength: 90,
                        maxBufferLength: 30,
                        maxMaxBufferLength: 600,
                        liveSyncDurationCount: 3,
                        xhrSetup: function(xhr, url) {
                            // æ·»åŠ è·¨åŸŸè¯·æ±‚å¤´
                            xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
                        }
                    });
                    
                    hlsInstance.loadSource(url);
                    hlsInstance.attachMedia(videoElement);
                    
                    hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
                        showToast('ç›´è¿HLSæµè§£ææˆåŠŸï¼', 'success');
                        setupVideoEvents(videoElement, savedProgress);
                    });
                    
                    hlsInstance.on(Hls.Events.ERROR, (event, data) => {
                        console.error('ç›´è¿HLSé”™è¯¯:', data);
                        
                        if (data.fatal) {
                            showToast('ç›´è¿æ’­æ”¾å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–æ’­æ”¾æ–¹å¼', 'error');
                            showPlayOptions(currentEpisode);
                        }
                    });
                } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                    // SafariåŸç”Ÿæ”¯æŒ
                    videoElement.src = url;
                    showToast('ä½¿ç”¨åŸç”ŸHLSç›´è¿æ’­æ”¾', 'info');
                    setupVideoEvents(videoElement, savedProgress);
                } else {
                    // é™çº§åˆ°Video.jsç›´è¿
                    const options = {
                        controls: true,
                        responsive: true,
                        fluid: false,
                        fill: true,
                        preload: 'auto',
                        sources: [{
                            src: url,
                            type: 'application/x-mpegURL'
                        }],
                        html5: {
                            vhs: {
                                overrideNative: !videojs.browser.IS_SAFARI
                            }
                        }
                    };
                    
                    if (videoElement.player) {
                        videoElement.player.dispose();
                    }
                    
                    videoPlayer = videojs(videoElement, options, function() {
                        showToast('Video.jsç›´è¿æ’­æ”¾å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                        setupVideoJSEvents(this, savedProgress);
                    });
                    
                    videoPlayer.on('error', (e) => {
                        const error = videoPlayer.error();
                        console.error('Video.jsç›´è¿é”™è¯¯:', error);
                        showToast('ç›´è¿æ’­æ”¾å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–æ’­æ”¾æ–¹å¼', 'error');
                        showPlayOptions(currentEpisode);
                    });
                }
                
            } catch (error) {
                console.error('åˆ›å»ºç›´è¿æ’­æ”¾å™¨å¤±è´¥:', error);
                showToast('æ— æ³•åˆ›å»ºæ’­æ”¾å™¨ï¼Œè¯·å°è¯•å…¶ä»–æ–¹å¼', 'error');
                showPlayOptions(currentEpisode);
            }
        }
        
        // æ˜¾ç¤ºæ’­æ”¾é€‰é¡¹
        function showPlayOptions(episode) {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">é€‰æ‹©æ’­æ”¾æ–¹å¼</h3>
                    <p class="mb-4 text-gray-600">ç”±äºè§†é¢‘æœåŠ¡å™¨é™åˆ¶ï¼Œè¯·é€‰æ‹©åˆé€‚çš„æ’­æ”¾æ–¹å¼ï¼š</p>
                    <div class="space-y-3">
                        <button onclick="openInNewTab('${episode.url}')" class="w-full px-4 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all flex items-center justify-center">
                            <i class="fa fa-external-link mr-2"></i> åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€
                        </button>
                        <button onclick="tryIframePlay('${episode.url}')" class="w-full px-4 py-3 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-all flex items-center justify-center">
                            <i class="fa fa-play mr-2"></i> å°è¯•å†…åµŒæ’­æ”¾
                        </button>
                        <button onclick="copyVideoUrl('${episode.url}')" class="w-full px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all flex items-center justify-center">
                            <i class="fa fa-copy mr-2"></i> å¤åˆ¶é“¾æ¥åœ°å€
                        </button>
                    </div>
                    <div class="mt-4 pt-4 border-t">
                        <button onclick="closePlayOptions()" class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;
            dialog.id = 'playOptionsDialog';
            document.body.appendChild(dialog);
        }
        
        // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€
        function openInNewTab(url) {
            window.open(url, '_blank');
            closePlayOptions();
            showToast('å·²åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€è§†é¢‘', 'success');
        }
        
        // ä½¿ç”¨æ–°æ’­æ”¾å™¨æ’­æ”¾
        function tryIframePlay(url) {
            try {
                // æ¸…ç†ä¹‹å‰çš„æ’­æ”¾å™¨å®ä¾‹
                cleanupPlayer();
                
                // é‡ç½®è·³è½¬æ ‡å¿—ä½
                hasJumpedToProgress = false;
                
                // è·å–ä¿å­˜çš„æ’­æ”¾è¿›åº¦
                const savedProgress = getSavedProgress(currentVideo.id, currentEpisode.id);
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºHLSæµ
                const isHLS = url.toLowerCase().includes('.m3u8');
                
                // ä½¿ç”¨ä»£ç†æœåŠ¡å™¨çš„URLæ¥é¿å…è·¨åŸŸé—®é¢˜
                const proxyUrl = `/proxy/video?url=${encodeURIComponent(url)}`;
                
                showToast('æ­£åœ¨åˆå§‹åŒ–æ’­æ”¾å™¨...', 'info');
                
                // è·å–videoå…ƒç´ 
                const videoElement = document.getElementById('videoElement');
                
                if (isHLS) {
                    // å¯¹äºHLSæµï¼Œä¼˜å…ˆä½¿ç”¨hls.js
                    if (Hls.isSupported()) {
                        initHLSPlayer(proxyUrl, videoElement, savedProgress);
                    } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                        // SafariåŸç”Ÿæ”¯æŒHLS
                        initNativeHLSPlayer(proxyUrl, videoElement, savedProgress);
                    } else {
                        // é™çº§åˆ°Video.js
                        initVideoJSPlayer(proxyUrl, videoElement, savedProgress, true);
                    }
                } else {
                    // æ™®é€šè§†é¢‘æ–‡ä»¶ä½¿ç”¨Video.js
                    initVideoJSPlayer(proxyUrl, videoElement, savedProgress, false);
                }
                
                closePlayOptions();
                
            } catch (error) {
                console.error('åˆ›å»ºæ’­æ”¾å™¨å¤±è´¥:', error);
                showPlayOptions(currentEpisode);
            }
        }
        
        // æ¸…ç†æ’­æ”¾å™¨
        function cleanupPlayer() {
            // é”€æ¯HLSå®ä¾‹
            if (hlsInstance) {
                try {
                    hlsInstance.destroy();
                } catch (e) {
                    console.error('é”€æ¯HLSå®ä¾‹å¤±è´¥:', e);
                }
                hlsInstance = null;
            }
            
            // é”€æ¯Video.jsæ’­æ”¾å™¨å®ä¾‹
            if (videoPlayer) {
                try {
                    videoPlayer.dispose();
                } catch (e) {
                    console.error('é”€æ¯æ’­æ”¾å™¨å¤±è´¥:', e);
                }
                videoPlayer = null;
            }
        }
        
        // åˆå§‹åŒ–HLS.jsæ’­æ”¾å™¨ï¼ˆä½¿ç”¨æœåŠ¡å™¨ç«¯URLé‡å†™ï¼‰
        function initHLSPlayer(url, videoElement, savedProgress) {
            console.log('=== å¼€å§‹åˆå§‹åŒ–HLSæ’­æ”¾å™¨ ===');
            console.log('ä»£ç†URL:', url);
            console.log('è§†é¢‘å…ƒç´ :', videoElement);
            console.log('ä¿å­˜çš„è¿›åº¦:', savedProgress);
            
            // æ£€æŸ¥HLS.jsæ˜¯å¦å¯ç”¨
            if (typeof Hls === 'undefined') {
                console.error('HLS.jsåº“æœªåŠ è½½');
                showToast('æ’­æ”¾å™¨åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }
            
            // æ£€æŸ¥è§†é¢‘å…ƒç´ 
            if (!videoElement) {
                console.error('è§†é¢‘å…ƒç´ ä¸å­˜åœ¨');
                showToast('è§†é¢‘æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥', 'error');
                return;
            }
            
            // æ¸…ç†ä¹‹å‰çš„å®ä¾‹
            if (hlsInstance) {
                try {
                    hlsInstance.destroy();
                    console.log('å·²æ¸…ç†ä¹‹å‰çš„HLSå®ä¾‹');
                } catch (e) {
                    console.error('æ¸…ç†HLSå®ä¾‹å¤±è´¥:', e);
                }
                hlsInstance = null;
            }
            
            // ä½¿ç”¨ä¼˜åŒ–çš„HLS.jsé…ç½®ï¼ˆä½¿ç”¨æ–°çš„å‚æ•°æ ¼å¼ï¼‰
            const hlsConfig = {
                enableWorker: true,
                lowLatencyMode: false,
                backBufferLength: 90,
                maxBufferLength: 30,
                maxMaxBufferLength: 600,
                liveSyncDurationCount: 3,
                // ä½¿ç”¨æ–°çš„ç­–ç•¥é…ç½®ï¼ˆæ›¿ä»£å·²å¼ƒç”¨çš„å‚æ•°ï¼‰
                manifestLoadPolicy: {
                    default: {
                        maxTimeToFirstByteMs: 15000,
                        maxLoadTimeMs: 15000,
                        timeoutRetry: {
                            maxNumRetry: 5,
                            retryDelayMs: 1000,
                            maxRetryDelayMs: 0
                        },
                        errorRetry: {
                            maxNumRetry: 5,
                            retryDelayMs: 1000,
                            maxRetryDelayMs: 8000
                        }
                    }
                },
                playlistLoadPolicy: {
                    default: {
                        maxTimeToFirstByteMs: 15000,
                        maxLoadTimeMs: 15000,
                        timeoutRetry: {
                            maxNumRetry: 5,
                            retryDelayMs: 1000,
                            maxRetryDelayMs: 0
                        },
                        errorRetry: {
                            maxNumRetry: 5,
                            retryDelayMs: 1000,
                            maxRetryDelayMs: 8000
                        }
                    }
                },
                fragLoadPolicy: {
                    default: {
                        maxTimeToFirstByteMs: 25000,
                        maxLoadTimeMs: 25000,
                        timeoutRetry: {
                            maxNumRetry: 8,
                            retryDelayMs: 1500,
                            maxRetryDelayMs: 0
                        },
                        errorRetry: {
                            maxNumRetry: 8,
                            retryDelayMs: 1500,
                            maxRetryDelayMs: 8000
                        }
                    }
                },
                // è°ƒè¯•é…ç½®
                debug: false, // å…³é—­è°ƒè¯•æ—¥å¿—ï¼Œé¿å…æ§åˆ¶å°æ··ä¹±
                enableSoftwareAES: true,
                capLevelToPlayerSize: false,
                startPosition: savedProgress > 0 ? savedProgress : -1,
                // æ·»åŠ é¢å¤–çš„é…ç½®
                autoStartLoad: true,
                defaultAudioCodec: 'mp4a.40.2',
                xhrSetup: function(xhr, url) {
                    xhr.setRequestHeader('Cache-Control', 'no-cache');
                    xhr.setRequestHeader('Pragma', 'no-cache');
                },
                // æ·»åŠ æ›´å¤šä¼˜åŒ–é…ç½®
                abrEwmaDefaultEstimate: 500000,
                abrEwmaFastLive: 3,
                abrEwmaSlowLive: 9,
                abrEwmaDefaultVoD: 1000,
                abrEwmaFastVoD: 3,
                abrEwmaSlowVoD: 9,
                // ç¼“å†²é…ç½®
                highBufferWatchdogPeriod: 2,
                nudgeOffset: 0.1,
                nudgeMaxRetry: 3,
                // å…³é”®å¸§é…ç½®
                maxFragLookUpTolerance: 0.25,
                // è‡ªåŠ¨æ’­æ”¾é…ç½®
                autoPlay: true,
                // å¯ç”¨ç‰‡æ®µé¢„åŠ è½½
                startFragPrefetch: true
            };
            
            console.log('HLSé…ç½®:', hlsConfig);
            
            try {
                // åˆ›å»ºHLSå®ä¾‹
                hlsInstance = new Hls(hlsConfig);
                console.log('HLSå®ä¾‹åˆ›å»ºæˆåŠŸ');
                
                // è®¾ç½®åª’ä½“æº
                hlsInstance.loadSource(url);
                console.log('HLSæºè®¾ç½®æˆåŠŸ');
                
                // ç»‘å®šåª’ä½“å…ƒç´ 
                hlsInstance.attachMedia(videoElement);
                console.log('HLSåª’ä½“ç»‘å®šæˆåŠŸ');
                
                // ç›‘å¬æ‰€æœ‰é‡è¦äº‹ä»¶
                hlsInstance.on(Hls.Events.MEDIA_ATTACHING, (event, data) => {
                    console.log('ğŸ“º HLSåª’ä½“ attaching:', data);
                });
                
                hlsInstance.on(Hls.Events.MEDIA_ATTACHED, (event, data) => {
                    console.log('âœ… HLSåª’ä½“ attachedæˆåŠŸ');
                    showToast('æ’­æ”¾å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                });
                
                hlsInstance.on(Hls.Events.MANIFEST_LOADING, (event, data) => {
                    console.log('ğŸ“‹ HLSæ¸…å•å¼€å§‹åŠ è½½:', data.url);
                    showToast('æ­£åœ¨åŠ è½½æ’­æ”¾åˆ—è¡¨...', 'info');
                });
                
                hlsInstance.on(Hls.Events.MANIFEST_LOADED, (event, data) => {
                    console.log('âœ… HLSæ¸…å•åŠ è½½å®Œæˆ');
                    console.log('æ¸…å•å†…å®¹:', data);
                    showToast('æ’­æ”¾åˆ—è¡¨åŠ è½½å®Œæˆ', 'success');
                });
                
                hlsInstance.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                    console.log('âœ… HLSæ¸…å•è§£ææˆåŠŸ');
                    console.log('å¯ç”¨è´¨é‡çº§åˆ«:', data.levels.map((level, index) => ({
                        index: index,
                        width: level.width,
                        height: level.height,
                        bitrate: level.bitrate,
                        codec: level.codecSet
                    })));
                    console.log('ç¬¬ä¸€çº§:', data.firstLevel);
                    console.log('éŸ³è½¨:', data.audioTracks);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„çº§åˆ«
                    if (!data.levels || data.levels.length === 0) {
                        console.error('âŒ æ²¡æœ‰å¯ç”¨çš„è§†é¢‘çº§åˆ«');
                        showToast('HLSæµä¸­æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„è§†é¢‘', 'error');
                        return;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„çº§åˆ«
                    if (!data.levels || data.levels.length === 0) {
                        console.error('âŒ æ²¡æœ‰å¯ç”¨çš„è§†é¢‘çº§åˆ«');
                        showToast('HLSæµä¸­æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„è§†é¢‘', 'error');
                        return;
                    }
                    
                    showToast('HLSæµè§£ææˆåŠŸï¼Œå¼€å§‹æ’­æ”¾', 'success');
                    
                    // è®¾ç½®è§†é¢‘äº‹ä»¶
                    setupVideoEvents(videoElement, savedProgress);
                    
                    // ç¡®ä¿è§†é¢‘å…ƒç´ çš„æ§åˆ¶é¢æ¿æ˜¾ç¤º
                    if (videoElement) {
                        videoElement.controls = true;
                    }
                    
                // è‡ªåŠ¨æ’­æ”¾ - å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿ç‰‡æ®µåŠ è½½
                setTimeout(() => {
                    if (videoElement && videoElement.paused) {
                        console.log('ğŸ¬ å°è¯•è‡ªåŠ¨æ’­æ”¾...');
                        const playPromise = videoElement.play();
                        if (playPromise !== undefined) {
                            playPromise.then(() => {
                                console.log('âœ… è‡ªåŠ¨æ’­æ”¾æˆåŠŸ');
                                showToast('è§†é¢‘å¼€å§‹æ’­æ”¾', 'success');
                            }).catch(err => {
                                console.warn('âš ï¸ è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’:', err);
                                showToast('ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹æ’­æ”¾', 'info');
                                
                                // æ·»åŠ ä¸€ä¸ªç‚¹å‡»æ’­æ”¾çš„æç¤º
                                addPlayButtonOverlay(videoElement);
                            });
                        } else {
                            // å…¼å®¹æ—§æµè§ˆå™¨
                            try {
                                videoElement.play();
                                console.log('âœ… è‡ªåŠ¨æ’­æ”¾æˆåŠŸï¼ˆå…¼å®¹æ¨¡å¼ï¼‰');
                                showToast('è§†é¢‘å¼€å§‹æ’­æ”¾', 'success');
                            } catch (err) {
                                console.warn('âš ï¸ è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’:', err);
                                showToast('ç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹æ’­æ”¾', 'info');
                                
                                // æ·»åŠ ä¸€ä¸ªç‚¹å‡»æ’­æ”¾çš„æç¤º
                                addPlayButtonOverlay(videoElement);
                            }
                        }
                    } else {
                        console.log('ğŸ¬ è§†é¢‘å·²ç»åœ¨æ’­æ”¾çŠ¶æ€');
                    }
                }, 3000); // å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œç¡®ä¿ç‰‡æ®µåŠ è½½å®Œæˆ
                });
                
                hlsInstance.on(Hls.Events.LEVEL_LOADING, (event, data) => {
                    console.log('ğŸ”„ HLSå­çº§åˆ«å¼€å§‹åŠ è½½:', data.url, 'çº§åˆ«:', data.level);
                });
                
                hlsInstance.on(Hls.Events.LEVEL_LOADED, (event, data) => {
                    console.log('âœ… HLSå­çº§åˆ«åŠ è½½å®Œæˆ:', data.url, 'çº§åˆ«:', data.level);
                    console.log('ç‰‡æ®µæ•°é‡:', data.details?.fragments?.length || 0);
                    if (data.details?.fragments?.length > 0) {
                        console.log('é¦–ä¸ªç‰‡æ®µURL:', data.details.fragments[0]?.url);
                        console.log('æ€»æ—¶é•¿:', data.details.totalduration);
                        showToast(`å­çº§åˆ«åŠ è½½æˆåŠŸï¼ŒåŒ…å« ${data.details.fragments.length} ä¸ªç‰‡æ®µ`, 'success');
                    } else {
                        console.warn('âš ï¸ å­çº§åˆ«åŠ è½½å®Œæˆä½†æ²¡æœ‰ç‰‡æ®µ');
                        showToast('è­¦å‘Šï¼šå­çº§åˆ«æ²¡æœ‰æ‰¾åˆ°è§†é¢‘ç‰‡æ®µ', 'warning');
                    }
                });
                
                hlsInstance.on(Hls.Events.FRAG_LOADING, (event, data) => {
                    console.log('ğŸ”„ ç‰‡æ®µå¼€å§‹åŠ è½½:', data.frag?.url, 'çº§åˆ«:', data.frag?.level);
                });
                
                hlsInstance.on(Hls.Events.FRAG_LOADED, (event, data) => {
                    console.log('âœ… ç‰‡æ®µåŠ è½½æˆåŠŸ:', data.frag?.url, 'å¤§å°:', data.payload?.byteLength, 'å­—èŠ‚');
                });
                
                hlsInstance.on(Hls.Events.FRAG_PARSED, (event, data) => {
                    console.log('âœ… ç‰‡æ®µè§£æå®Œæˆ:', data.frag?.url);
                });
                
                hlsInstance.on(Hls.Events.FRAG_BUFFERED, (event, data) => {
                    console.log('âœ… ç‰‡æ®µç¼“å†²å®Œæˆ:', data.frag?.url);
                });
                
                hlsInstance.on(Hls.Events.ERROR, (event, data) => {
                    console.error('âŒ HLSé”™è¯¯:', data);
                    console.error('é”™è¯¯è¯¦æƒ…:', {
                        type: data.type,
                        details: data.details,
                        fatal: data.fatal,
                        reason: data.reason,
                        url: data.url,
                        code: data.code
                    });
                    
                    if (data.fatal) {
                        let errorMessage = '';
                        let shouldShowDialog = false;
                        
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œå°è¯•æ¢å¤...';
                                if (data.details === 'manifestLoadError') {
                                    console.log('âŒ æ¸…å•æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯ä»£ç†é—®é¢˜');
                                    errorMessage = 'HLSæ¸…å•æ–‡ä»¶åŠ è½½å¤±è´¥';
                                    shouldShowDialog = true;
                                } else if (data.details === 'levelLoadError') {
                                    console.log('âŒ å­æ¸…å•åŠ è½½å¤±è´¥');
                                    errorMessage = 'HLSå­æ¸…å•æ–‡ä»¶åŠ è½½å¤±è´¥';
                                    shouldShowDialog = true;
                                } else if (data.details === 'fragLoadError') {
                                    console.log('âŒ ç‰‡æ®µåŠ è½½å¤±è´¥ï¼Œå°è¯•æ¢å¤');
                                    errorMessage = 'è§†é¢‘ç‰‡æ®µåŠ è½½å¤±è´¥ï¼Œå°è¯•æ¢å¤...';
                                    showToast(errorMessage, 'warning');
                                    
                                    // å°è¯•æ¢å¤ç‰‡æ®µåŠ è½½é”™è¯¯
                                    setTimeout(() => {
                                        if (hlsInstance) {
                                            console.log('ğŸ”„ å°è¯•æ¢å¤ç‰‡æ®µåŠ è½½...');
                                            hlsInstance.startLoad();
                                        }
                                    }, 1000);
                                    return;
                                }
                                
                                if (shouldShowDialog) {
                                    showHLSErrorDialog(currentEpisode, {
                                        errorType: data.type,
                                        errorCode: data.code,
                                        errorDetails: data.details,
                                        message: data.reason || data.details || errorMessage,
                                        url: data.url
                                    });
                                } else {
                                    showToast(errorMessage, 'warning');
                                    
                                    // å°è¯•æ¢å¤ç½‘ç»œé”™è¯¯
                                    setTimeout(() => {
                                        if (hlsInstance) {
                                            console.log('ğŸ”„ å°è¯•æ¢å¤ç½‘ç»œé”™è¯¯...');
                                            hlsInstance.startLoad();
                                        }
                                    }, 1000);
                                }
                                break;
                                
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                errorMessage = 'åª’ä½“é”™è¯¯ï¼Œå°è¯•æ¢å¤...';
                                showToast(errorMessage, 'warning');
                                
                                // å°è¯•æ¢å¤åª’ä½“é”™è¯¯
                                setTimeout(() => {
                                    if (hlsInstance) {
                                        console.log('ğŸ”„ å°è¯•æ¢å¤åª’ä½“é”™è¯¯...');
                                        hlsInstance.recoverMediaError();
                                    }
                                }, 1000);
                                break;
                                
                            default:
                                shouldShowDialog = true;
                                break;
                        }
                        
                        // å¦‚æœæ˜¯ä»£ç†ç›¸å…³é”™è¯¯ï¼Œå°è¯•ç›´è¿æ’­æ”¾
                        if ((data.details === 'manifestLoadError' || data.details === 'levelLoadError') && 
                            data.url && data.url.includes('/proxy/')) {
                            console.log('ğŸ”„ ä»£ç†åŠ è½½å¤±è´¥ï¼Œå°è¯•ç›´è¿æ’­æ”¾');
                            showToast('ä»£ç†åŠ è½½å¤±è´¥ï¼Œæ­£åœ¨å°è¯•ç›´è¿æ’­æ”¾...', 'warning');
                            // ä»ä»£ç†URLä¸­æå–åŸå§‹URL
                            const urlMatch = data.url.match(/\/proxy\/video\?url=([^&]+)/);
                            if (urlMatch) {
                                const originalUrl = decodeURIComponent(urlMatch[1]);
                                setTimeout(() => {
                                    tryDirectHLSPlay(originalUrl);
                                }, 1000);
                                return;
                            }
                        }
                        
                        // å¦‚æœå¤šæ¬¡æ¢å¤å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†
                        if (shouldShowDialog || data.details === 'levelLoadTimeOut' || data.details === 'fragLoadTimeOut') {
                            showHLSErrorDialog(currentEpisode, {
                                errorType: data.type,
                                errorCode: data.code,
                                errorDetails: data.details,
                                message: data.reason || data.details || 'HLSæ’­æ”¾å¤±è´¥',
                                url: data.url
                            });
                        }
                    } else {
                        // éè‡´å‘½é”™è¯¯ï¼Œè®°å½•ä½†ç»§ç»­æ’­æ”¾
                        console.warn('âš ï¸ HLSéè‡´å‘½é”™è¯¯:', data);
                    }
                });
                
                // ç›‘å¬ç¼“å†²çŠ¶æ€
                hlsInstance.on(Hls.Events.BUFFER_APPENDING, () => {
                    console.log('ğŸ“¥ å¼€å§‹æ·»åŠ æ•°æ®åˆ°ç¼“å†²åŒº');
                });
                
                hlsInstance.on(Hls.Events.BUFFER_APPENDED, () => {
                    console.log('âœ… æ•°æ®å·²æ·»åŠ åˆ°ç¼“å†²åŒº');
                });
                
                hlsInstance.on(Hls.Events.BUFFER_EOS, () => {
                    console.log('ğŸ ç¼“å†²åŒºåˆ°è¾¾æœ«å°¾');
                });
                
                // ç›‘å¬é¦–å¸§æ¸²æŸ“
                hlsInstance.on(Hls.Events.INIT_PTS_FOUND, () => {
                    console.log('ğŸ¬ æ‰¾åˆ°åˆå§‹æ—¶é—´æˆ³ï¼Œå³å°†å¼€å§‹æ’­æ”¾');
                    showToast('è§†é¢‘å³å°†å¼€å§‹æ’­æ”¾...', 'info');
                });
                
                console.log('âœ… HLSæ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ HLSæ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                showToast('æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                
                // å°è¯•é™çº§åˆ°Video.js
                setTimeout(() => {
                    initVideoJSPlayer(url, videoElement, savedProgress, true);
                }, 1000);
            }
        }
        
        // åˆå§‹åŒ–åŸç”ŸHLSæ’­æ”¾å™¨ (Safari)
        function initNativeHLSPlayer(url, videoElement, savedProgress) {
            videoElement.src = url;
            showToast('ä½¿ç”¨åŸç”ŸHLSæ’­æ”¾', 'info');
            setupVideoEvents(videoElement, savedProgress);
        }
        
        // åˆå§‹åŒ–Video.jsæ’­æ”¾å™¨
        function initVideoJSPlayer(url, videoElement, savedProgress, isHLS) {
            const options = {
                controls: true,
                responsive: true,
                fluid: false,
                fill: true,
                preload: 'auto',
                sources: [{
                    src: url,
                    type: isHLS ? 'application/x-mpegURL' : 'video/mp4'
                }],
                html5: {
                    vhs: {
                        overrideNative: !videojs.browser.IS_SAFARI
                    }
                }
            };
            
            // ç¡®ä¿ä¹‹å‰çš„å®ä¾‹è¢«æ¸…ç†
            if (videoElement.player) {
                videoElement.player.dispose();
            }
            
            videoPlayer = videojs(videoElement, options, function() {
                showToast('Video.jsæ’­æ”¾å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                setupVideoJSEvents(this, savedProgress);
            });
            
            videoPlayer.on('error', (e) => {
                const error = videoPlayer.error();
                console.error('Video.jsé”™è¯¯:', error);
                
                if (isHLS) {
                    showHLSErrorDialog(currentEpisode, {
                        errorType: 'Video.js',
                        errorCode: error ? error.code : 'unknown',
                        message: error ? error.message : 'æ’­æ”¾å¤±è´¥'
                    });
                } else {
                    showPlayOptions(currentEpisode);
                }
            });
        }
        
        // è®¾ç½®åŸç”Ÿvideoäº‹ä»¶
        function setupVideoEvents(videoElement, savedProgress) {
            videoElement.addEventListener('loadstart', () => {
                showToast('å¼€å§‹åŠ è½½è§†é¢‘...', 'info');
            });
            
            videoElement.addEventListener('canplay', () => {
                showToast('è§†é¢‘åŠ è½½å®Œæˆï¼Œå¯ä»¥æ’­æ”¾', 'success');
                
                // è·³è½¬åˆ°ä¿å­˜çš„è¿›åº¦
                if (savedProgress > 0 && !hasJumpedToProgress) {
                    hasJumpedToProgress = true;
                    videoElement.currentTime = savedProgress;
                    showToast(`å·²è·³è½¬åˆ°ä¸Šæ¬¡æ’­æ”¾ä½ç½®: ${formatTime(savedProgress)}`, 'info');
                }
            });
            
            videoElement.addEventListener('timeupdate', () => {
                if (currentVideo && currentEpisode && videoElement.currentTime > 0) {
                    // æ¯30ç§’ä¿å­˜ä¸€æ¬¡è¿›åº¦
                    const currentTime = Math.floor(videoElement.currentTime);
                    if (currentTime % 30 === 0) {
                        saveProgress(currentVideo.id, currentEpisode.id, currentTime);
                    }
                }
            });
            
            videoElement.addEventListener('error', (e) => {
                console.error('Videoå…ƒç´ é”™è¯¯:', e);
                showPlayOptions(currentEpisode);
            });
        }
        
        // è®¾ç½®Video.jsäº‹ä»¶
        function setupVideoJSEvents(player, savedProgress) {
            player.on('loadstart', () => {
                showToast('å¼€å§‹åŠ è½½è§†é¢‘...', 'info');
            });
            
            player.on('canplay', () => {
                showToast('è§†é¢‘åŠ è½½å®Œæˆï¼Œå¯ä»¥æ’­æ”¾', 'success');
                
                // è·³è½¬åˆ°ä¿å­˜çš„è¿›åº¦
                if (savedProgress > 0 && !hasJumpedToProgress) {
                    hasJumpedToProgress = true;
                    player.currentTime(savedProgress);
                    showToast(`å·²è·³è½¬åˆ°ä¸Šæ¬¡æ’­æ”¾ä½ç½®: ${formatTime(savedProgress)}`, 'info');
                }
            });
            
            player.on('timeupdate', () => {
                if (currentVideo && currentEpisode && player.currentTime() > 0) {
                    // æ¯30ç§’ä¿å­˜ä¸€æ¬¡è¿›åº¦
                    const currentTime = Math.floor(player.currentTime());
                    if (currentTime % 30 === 0) {
                        saveProgress(currentVideo.id, currentEpisode.id, currentTime);
                    }
                }
            });
        }
        
        // é€šç”¨å¤åˆ¶åˆ°å‰ªè´´æ¿å‡½æ•°
        function copyToClipboard(text) {
            // æ£€æŸ¥æ˜¯å¦æ”¯æŒç°ä»£å‰ªè´´æ¿API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                // ä½¿ç”¨fallbackæ–¹æ³•
                fallbackCopyTextToClipboard(text);
            }
        }
        
        // fallbackå¤åˆ¶æ–¹æ³•
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            
            // é¿å…æ»šåŠ¨åˆ°åº•éƒ¨
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } else {
                    showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                }
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        // å¤åˆ¶è§†é¢‘é“¾æ¥
        function copyVideoUrl(url) {
            copyToClipboard(url);
            closePlayOptions();
        }
        
        // å…³é—­æ’­æ”¾é€‰é¡¹å¯¹è¯æ¡†
        function closePlayOptions() {
            const dialog = document.getElementById('playOptionsDialog');
            if (dialog) {
                document.body.removeChild(dialog);
            }
        }

        // æ‰‹åŠ¨ä¿å­˜æ’­æ”¾è¿›åº¦
        function saveProgressManually() {
            if (!currentVideo || !currentEpisode) {
                showToast('è¯·å…ˆæ’­æ”¾è§†é¢‘', 'warning');
                return;
            }
            
            let currentTime = 0;
            let success = false;
            
            try {
                // å°è¯•ä»Video.jsæ’­æ”¾å™¨è·å–æ—¶é—´
                if (videoPlayer && typeof videoPlayer.currentTime === 'function') {
                    currentTime = videoPlayer.currentTime();
                    if (!isNaN(currentTime) && currentTime > 0) {
                        success = true;
                    }
                }
                
                // å¦‚æœVideo.jså¤±è´¥ï¼Œå°è¯•ä»åŸç”Ÿvideoå…ƒç´ è·å–
                if (!success) {
                    const videoElement = document.getElementById('videoElement');
                    if (videoElement && !isNaN(videoElement.currentTime) && videoElement.currentTime > 0) {
                        currentTime = videoElement.currentTime;
                        success = true;
                    }
                }
                
                if (success) {
                    saveProgress(currentVideo.id, currentEpisode.id, currentTime);
                    showToast(`è¿›åº¦å·²ä¿å­˜: ${formatTime(currentTime)}`, 'success');
                    return;
                }
                
                // å¦‚æœéƒ½æ— æ³•è·å–æ’­æ”¾æ—¶é—´ï¼Œæ˜¾ç¤ºæ—¶é—´é€‰æ‹©å™¨
                showTimeSelector();
                
            } catch (e) {
                console.error('è·å–æ’­æ”¾æ—¶é—´å¤±è´¥:', e);
                showTimeSelector();
            }
        }
        
        // æ˜¾ç¤ºæ—¶é—´é€‰æ‹©å™¨
        function showTimeSelector() {
            // åˆ›å»ºæ—¶é—´é€‰æ‹©å™¨å¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.id = 'timeSelectorDialog';
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            dialog.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4 text-center">è®¾ç½®æ’­æ”¾è¿›åº¦</h3>
                    <div class="flex items-center justify-center space-x-2 mb-6">
                        <div class="text-center">
                            <label class="block text-sm text-gray-600 mb-1">æ—¶</label>
                            <input type="number" id="hours" min="0" max="23" value="0" 
                                   class="w-16 px-2 py-1 border rounded text-center">
                        </div>
                        <span class="text-xl font-bold mt-6">:</span>
                        <div class="text-center">
                            <label class="block text-sm text-gray-600 mb-1">åˆ†</label>
                            <input type="number" id="minutes" min="0" max="59" value="0" 
                                   class="w-16 px-2 py-1 border rounded text-center">
                        </div>
                        <span class="text-xl font-bold mt-6">:</span>
                        <div class="text-center">
                            <label class="block text-sm text-gray-600 mb-1">ç§’</label>
                            <input type="number" id="seconds" min="0" max="59" value="0" 
                                   class="w-16 px-2 py-1 border rounded text-center">
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="cancelTimeSelector()" 
                                class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all">
                            å–æ¶ˆ
                        </button>
                        <button onclick="confirmTimeSelector()" 
                                class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-all">
                            ç¡®è®¤ä¿å­˜
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            // è‡ªåŠ¨èšç„¦åˆ°åˆ†é’Ÿè¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('minutes').focus();
            }, 100);
        }
        
        // å–æ¶ˆæ—¶é—´é€‰æ‹©å™¨
        function cancelTimeSelector() {
            const dialog = document.getElementById('timeSelectorDialog');
            if (dialog) {
                document.body.removeChild(dialog);
            }
        }
        
        // ç¡®è®¤æ—¶é—´é€‰æ‹©å™¨
        function confirmTimeSelector() {
            const hours = parseInt(document.getElementById('hours').value) || 0;
            const minutes = parseInt(document.getElementById('minutes').value) || 0;
            const seconds = parseInt(document.getElementById('seconds').value) || 0;
            
            // éªŒè¯è¾“å…¥å€¼
            if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59 || seconds < 0 || seconds > 59) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´å€¼', 'error');
                return;
            }
            
            // è½¬æ¢ä¸ºæ€»ç§’æ•°
            const totalSeconds = hours * 3600 + minutes * 60 + seconds;
            
            if (totalSeconds === 0) {
                showToast('è¯·è®¾ç½®ä¸€ä¸ªæœ‰æ•ˆçš„æ—¶é—´', 'warning');
                return;
            }
            
            // ä¿å­˜è¿›åº¦
            saveProgress(currentVideo.id, currentEpisode.id, totalSeconds);
            showToast(`è¿›åº¦å·²ä¿å­˜: ${formatTime(totalSeconds)}`, 'success');
            
            // å…³é—­å¯¹è¯æ¡†
            cancelTimeSelector();
        }

        // æˆªå›¾
        function takeScreenshot() {
            if (!currentVideo || !currentEpisode) {
                showToast('è¯·å…ˆæ’­æ”¾è§†é¢‘', 'warning');
                return;
            }
            
            const videoElement = document.getElementById('videoElement');
            if (!videoElement) {
                showToast('è¯·å…ˆæ’­æ”¾è§†é¢‘', 'warning');
                return;
            }
            
            try {
                // ç›´æ¥ä½¿ç”¨canvasæˆªå›¾æ–¹æ¡ˆ
                fallbackCanvasScreenshot();
            } catch (e) {
                console.error('æˆªå›¾å¤±è´¥:', e);
                showToast('æˆªå›¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
        
        // å¤‡é€‰canvasæˆªå›¾æ–¹æ¡ˆ
        function fallbackCanvasScreenshot() {
            const video = document.getElementById('videoElement');
            if (video) {
                
                // æ£€æŸ¥è§†é¢‘æ˜¯å¦å¯ä»¥æˆªå›¾ï¼ˆé¿å…è·¨åŸŸé—®é¢˜ï¼‰
                if (video.crossOrigin !== 'anonymous' && video.src && !video.src.startsWith(window.location.origin)) {
                    showToast('ç”±äºè·¨åŸŸé™åˆ¶ï¼Œæ— æ³•æˆªå›¾æ­¤è§†é¢‘æº', 'warning');
                    return;
                }
                
                // åˆ›å»ºcanvasæ¥æˆªå–è§†é¢‘å¸§
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 360;
                
                try {
                    // æ£€æŸ¥canvasæ˜¯å¦è¢«æ±¡æŸ“
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // å°è¯•è·å–å›¾åƒæ•°æ®ï¼Œå¦‚æœcanvasè¢«æ±¡æŸ“ä¼šæŠ›å‡ºSecurityError
                    const dataURL = canvas.toDataURL('image/png');
                    
                    // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                    const downloadBtn = document.getElementById('downloadScreenshotBtn');
                    downloadBtn.dataset.screenshot = dataURL;
                    downloadBtn.classList.remove('hidden');
                    
                    showToast('æˆªå›¾æˆåŠŸï¼Œç‚¹å‡»ä¸‹è½½æŒ‰é’®ä¿å­˜', 'success');
                } catch (e) {
                    console.error('æˆªå›¾å¤±è´¥:', e);
                    if (e.name === 'SecurityError') {
                        showToast('ç”±äºå®‰å…¨é™åˆ¶ï¼Œæ— æ³•æˆªå›¾è·¨åŸŸè§†é¢‘ã€‚è¯·å°è¯•ä½¿ç”¨æ’­æ”¾å™¨è‡ªå¸¦çš„æˆªå›¾åŠŸèƒ½', 'warning');
                    } else {
                        showToast('æˆªå›¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    }
                }
            } else {
                showToast('æ— æ³•è·å–è§†é¢‘å…ƒç´ ï¼Œæˆªå›¾å¤±è´¥', 'error');
            }
        }

        // ä¸‹è½½æˆªå›¾
        function downloadScreenshot() {
            const screenshotData = document.getElementById('downloadScreenshotBtn').dataset.screenshot;
            if (!screenshotData) return;
            
            const link = document.createElement('a');
            link.href = screenshotData;
            link.download = `${currentEpisode.title}_æˆªå›¾.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('æˆªå›¾å·²ä¸‹è½½', 'success');
        }

        // ä¿å­˜æ’­æ”¾è¿›åº¦
        function saveProgress(videoId, episodeId, progress) {
            const savedProgress = JSON.parse(localStorage.getItem('videoProgress') || '{}');
            const key = `${videoId}_${episodeId}`;
            savedProgress[key] = progress;
            localStorage.setItem('videoProgress', JSON.stringify(savedProgress));
            
            // åˆ·æ–°DOMæ˜¾ç¤º
            refreshProgressDisplay(videoId, episodeId, progress);
        }
        
        // è·å–æœ€æ–°è§‚çœ‹è¿›åº¦æ˜¾ç¤º
        function getLatestProgressDisplay(videoData) {
            let latestProgress = 0;
            let latestEpisode = null;
            
            videoData.episodes.forEach(episode => {
                const progress = getSavedProgress(videoData.id, episode.id);
                if (progress > latestProgress) {
                    latestProgress = progress;
                    latestEpisode = episode;
                }
            });
            
            if (latestProgress > 0 && latestEpisode) {
                return `æœ€è¿‘è§‚çœ‹: ${latestEpisode.title} (${formatTime(latestProgress)})`;
            }
            return '';
        }
        
        // åˆ·æ–°è¿›åº¦æ˜¾ç¤º
        function refreshProgressDisplay(videoId, episodeId, progress) {
            // æ›´æ–°ç‰¹å®šè§†é¢‘å¡ç‰‡çš„è¿›åº¦æ˜¾ç¤º
            const progressElement = document.getElementById(`latest-progress-${videoId}`);
            if (progressElement) {
                const videoData = JSON.parse(localStorage.getItem('videoPlaylists') || '[]')
                    .find(video => video.id === videoId);
                if (videoData) {
                    progressElement.textContent = getLatestProgressDisplay(videoData);
                }
            }
            
            // é‡æ–°åŠ è½½è§†é¢‘åˆ—è¡¨ä»¥æ›´æ–°æ‰€æœ‰è¿›åº¦æ˜¾ç¤º
            loadVideos();
        }

        // è·å–ä¿å­˜çš„æ’­æ”¾è¿›åº¦
        function getSavedProgress(videoId, episodeId) {
            const savedProgress = JSON.parse(localStorage.getItem('videoProgress') || '{}');
            const key = `${videoId}_${episodeId}`;
            return savedProgress[key] || 0;
        }

        // æ¸…é™¤ä¿å­˜çš„æ’­æ”¾è¿›åº¦
        function clearSavedProgress(videoId, episodeId) {
            const savedProgress = JSON.parse(localStorage.getItem('videoProgress') || '{}');
            const key = `${videoId}_${episodeId}`;
            if (savedProgress[key]) {
                delete savedProgress[key];
                localStorage.setItem('videoProgress', JSON.stringify(savedProgress));
            }
        }

        // æ’å…¥æ¨¡æ¿
        function insertTemplate() {
            const template = `ç¤ºä¾‹ç”µè§†å‰§åç§°
<b>ç¬¬01é›†</b>https://example.com/video1.mp4
<b>ç¬¬02é›†</b>https://example.com/video2.mp4
<b>ç¬¬03é›†</b>https://example.com/video3.mp4`;
            document.getElementById('videoUrls').value = template;
            showToast('æ¨¡æ¿å·²æ’å…¥ï¼Œè¯·ä¿®æ”¹ä¸ºå®é™…å†…å®¹', 'success');
        }

        // æ¸…ç©ºè¾“å…¥
        function clearInput() {
            document.getElementById('videoUrls').value = '';
        }

        // åˆ é™¤è§†é¢‘
        function deleteVideo(videoId) {
            const savedVideos = JSON.parse(localStorage.getItem('videoPlaylists') || '[]');
            const updatedVideos = savedVideos.filter(video => video.id !== videoId);
            localStorage.setItem('videoPlaylists', JSON.stringify(updatedVideos));
            
            // æ¸…é™¤è¯¥è§†é¢‘çš„æ‰€æœ‰æ’­æ”¾è¿›åº¦
            const savedProgress = JSON.parse(localStorage.getItem('videoProgress') || '{}');
            Object.keys(savedProgress).forEach(key => {
                if (key.startsWith(videoId)) {
                    delete savedProgress[key];
                }
            });
            localStorage.setItem('videoProgress', JSON.stringify(savedProgress));
            
            loadVideos();
            showToast('è§†é¢‘å·²åˆ é™¤', 'success');
        }

        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        function showConfirmDialog(message, title = 'ç¡®è®¤æ“ä½œ') {
            document.getElementById('dialogTitle').textContent = title;
            document.getElementById('dialogMessage').textContent = message;
            document.getElementById('confirmDialog').classList.remove('hidden');
        }

        // éšè—ç¡®è®¤å¯¹è¯æ¡†
        function hideConfirmDialog() {
            document.getElementById('confirmDialog').classList.add('hidden');
            videoToDelete = null;
        }

        // ç¡®è®¤åˆ é™¤è§†é¢‘
        function confirmDeleteVideo() {
            if (videoToDelete) {
                deleteVideo(videoToDelete);
                hideConfirmDialog();
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            // è®¡ç®—å½“å‰å·²å­˜åœ¨çš„toastæ•°é‡ï¼Œé¿å…é‡å 
            const existingToasts = document.querySelectorAll('.toast-message');
            const topOffset = 16 + (existingToasts.length * 80); // æ¯ä¸ªtoasté«˜åº¦çº¦64px + 16pxé—´è·
            
            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            toast.className = `toast-message fixed right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                type === 'warning' ? 'bg-yellow-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            toast.style.top = `${topOffset}px`;
            toast.textContent = message;
            
            // æ·»åŠ åˆ°body
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
                toast.classList.add('translate-x-0');
            }, 10);
            
            // 3ç§’åéšè—
            setTimeout(() => {
                toast.classList.remove('translate-x-0');
                toast.classList.add('translate-x-full');
                
                // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}å°æ—¶${minutes}åˆ†${secs}ç§’`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†${secs}ç§’`;
            } else {
                return `${secs}ç§’`;
            }
        }
        
        // æ·»åŠ æ’­æ”¾æŒ‰é’®è¦†ç›–å±‚
        function addPlayButtonOverlay(videoElement) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨æ’­æ”¾æŒ‰é’®è¦†ç›–å±‚
            const existingOverlay = document.getElementById('playButtonOverlay');
            if (existingOverlay) {
                return; // å·²å­˜åœ¨ï¼Œä¸å†æ·»åŠ 
            }
            
            // è·å–è§†é¢‘æ’­æ”¾å™¨å®¹å™¨
            const videoPlayer = document.getElementById('videoPlayer');
            if (!videoPlayer) return;
            
            // åˆ›å»ºè¦†ç›–å±‚
            const overlay = document.createElement('div');
            overlay.id = 'playButtonOverlay';
            overlay.className = 'absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20';
            overlay.style.cursor = 'pointer';
            
            // åˆ›å»ºæ’­æ”¾æŒ‰é’®
            const playButton = document.createElement('div');
            playButton.className = 'w-20 h-20 bg-white bg-opacity-80 rounded-full flex items-center justify-center hover:bg-opacity-100 transition-all';
            playButton.innerHTML = '<i class="fa fa-play text-3xl text-primary ml-1"></i>';
            
            // åˆ›å»ºæç¤ºæ–‡æœ¬
            const hintText = document.createElement('div');
            hintText.className = 'absolute bottom-10 text-white text-lg font-medium';
            hintText.textContent = 'ç‚¹å‡»æ’­æ”¾è§†é¢‘';
            
            // ç»„è£…è¦†ç›–å±‚
            overlay.appendChild(playButton);
            overlay.appendChild(hintText);
            videoPlayer.appendChild(overlay);
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            overlay.addEventListener('click', () => {
                // å°è¯•æ’­æ”¾è§†é¢‘
                if (videoElement && videoElement.paused) {
                    const playPromise = videoElement.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('âœ… æ‰‹åŠ¨æ’­æ”¾æˆåŠŸ');
                            showToast('è§†é¢‘å¼€å§‹æ’­æ”¾', 'success');
                            // ç§»é™¤è¦†ç›–å±‚
                            if (overlay.parentNode) {
                                overlay.parentNode.removeChild(overlay);
                            }
                        }).catch(err => {
                            console.error('âŒ æ‰‹åŠ¨æ’­æ”¾å¤±è´¥:', err);
                            showToast('æ’­æ”¾å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                            
                            // æ·»åŠ ä¸€ä¸ªç®€å•çš„æ’­æ”¾æŒ‰é’®åˆ°è§†é¢‘å…ƒç´ ä¸Š
                            addSimplePlayButton(videoElement);
                        });
                    } else {
                        // å…¼å®¹æ—§æµè§ˆå™¨
                        try {
                            videoElement.play();
                            console.log('âœ… æ‰‹åŠ¨æ’­æ”¾æˆåŠŸï¼ˆå…¼å®¹æ¨¡å¼ï¼‰');
                            showToast('è§†é¢‘å¼€å§‹æ’­æ”¾', 'success');
                            // ç§»é™¤è¦†ç›–å±‚
                            if (overlay.parentNode) {
                                overlay.parentNode.removeChild(overlay);
                            }
                        } catch (err) {
                            console.error('âŒ æ‰‹åŠ¨æ’­æ”¾å¤±è´¥ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰:', err);
                            showToast('æ’­æ”¾å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                            
                            // æ·»åŠ ä¸€ä¸ªç®€å•çš„æ’­æ”¾æŒ‰é’®åˆ°è§†é¢‘å…ƒç´ ä¸Š
                            addSimplePlayButton(videoElement);
                        }
                    }
                }
            });
        }
        
        // æ·»åŠ ç®€å•æ’­æ”¾æŒ‰é’®ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        function addSimplePlayButton(videoElement) {
            // ç§»é™¤ç°æœ‰çš„ç®€å•æ’­æ”¾æŒ‰é’®
            const existingBtn = document.getElementById('simplePlayButton');
            if (existingBtn) {
                existingBtn.remove();
            }
            
            // åˆ›å»ºç®€å•çš„æ’­æ”¾æŒ‰é’®
            const playBtn = document.createElement('button');
            playBtn.id = 'simplePlayButton';
            playBtn.innerHTML = '<i class="fa fa-play"></i> ç‚¹å‡»æ’­æ”¾';
            playBtn.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary/90 transition-all z-30';
            
            // æ·»åŠ åˆ°è§†é¢‘æ’­æ”¾å™¨å®¹å™¨
            const videoPlayer = document.getElementById('videoPlayer');
            if (videoPlayer) {
                videoPlayer.appendChild(playBtn);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                playBtn.addEventListener('click', () => {
                    if (videoElement && videoElement.paused) {
                        const playPromise = videoElement.play();
                        if (playPromise !== undefined) {
                            playPromise.then(() => {
                                console.log('âœ… ç®€å•æŒ‰é’®æ’­æ”¾æˆåŠŸ');
                                showToast('è§†é¢‘å¼€å§‹æ’­æ”¾', 'success');
                                playBtn.remove();
                            }).catch(err => {
                                console.error('âŒ ç®€å•æŒ‰é’®æ’­æ”¾å¤±è´¥:', err);
                                showToast('æ’­æ”¾ä»ç„¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯', 'error');
                            });
                        } else {
                            // å…¼å®¹æ—§æµè§ˆå™¨
                            try {
                                videoElement.play();
                                console.log('âœ… ç®€å•æŒ‰é’®æ’­æ”¾æˆåŠŸï¼ˆå…¼å®¹æ¨¡å¼ï¼‰');
                                showToast('è§†é¢‘å¼€å§‹æ’­æ”¾', 'success');
                                playBtn.remove();
                            } catch (err) {
                                console.error('âŒ ç®€å•æŒ‰é’®æ’­æ”¾å¤±è´¥ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰:', err);
                                showToast('æ’­æ”¾ä»ç„¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯', 'error');
                            }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>
