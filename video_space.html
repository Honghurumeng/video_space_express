<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Space</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- HLS.js 播放器 -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
    <!-- Video.js 播放器作为备选 -->
    <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
    <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet">
    <!-- Video.js HLS插件 -->
    <script src="https://cdn.jsdelivr.net/npm/@videojs/http-streaming@3.0.2/dist/videojs-http-streaming.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .tooltip {
                position: relative;
            }
            .tooltip::after {
                content: attr(data-tooltip);
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                padding: 4px 8px;
                background-color: rgba(0, 0, 0, 0.75);
                color: white;
                border-radius: 4px;
                font-size: 12px;
                white-space: nowrap;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.2s, transform 0.2s;
                z-index: 50;
            }
            .tooltip:hover::after {
                opacity: 1;
                transform: translateX(-50%) translateY(-4px);
            }
        }
        
        /* 视频播放器样式优化 */
        #videoPlayer {
            position: relative;
            overflow: hidden;
            background: #000;
        }

        #videoPlayer video {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain !important;
            max-width: 100% !important;
            max-height: 100% !important;
        }

        /* Video.js播放器样式 */
        .video-js {
            width: 100% !important;
            height: 100% !important;
        }

        .video-js .vjs-tech {
            object-fit: contain !important;
        }

        /* HLS错误样式 */
        .hls-error {
            color: #dc2626;
            background-color: #fee2e2;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-dark">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-md sticky top-0 z-50 mb-4">
        <div class="w-full px-6 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fa fa-film text-primary text-2xl mr-2"></i>
                <h1 class="text-xl font-bold text-dark">Video Space</h1>
            </div>
            <div class="flex items-center">
                <button 
                    id="showInputBtn" 
                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all flex items-center"
                >
                    <i class="fa fa-plus mr-2"></i> 添加视频
                </button>
            </div>
        </div>
    </nav>

    <!-- 粘贴视频地址区域 (默认隐藏) -->
    <section id="inputSection" class="bg-white rounded-xl shadow-lg p-4 mb-4 mx-2 hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold flex items-center">
                <i class="fa fa-paste text-primary mr-2"></i> 粘贴视频地址
            </h2>
            <button 
                id="closeInputBtn" 
                class="text-gray-500 hover:text-gray-700 transition-colors"
            >
                <i class="fa fa-times text-xl"></i>
            </button>
        </div>
        <div class="mb-4">
            <textarea 
                id="videoUrls" 
                class="w-full h-40 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                placeholder="请粘贴视频地址，格式如下：
环球钓鱼大冒险
<b>第01集</b>https://v.lzcdn25.com/share/934b535800b1cba8f96a5d72f72f1611
<b>第02集</b>https://v.lzcdn25.com/share/598920e11d1eb2a49501d59fce5ecbb7
<b>第03集</b>https://v.lzcdn25.com/share/d2a27e83d429f0dcae6b937cf440aeb1"
            ></textarea>
        </div>
        <div class="flex flex-wrap gap-3">
            <button 
                id="parseBtn" 
                class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all flex items-center"
            >
                <i class="fa fa-magic mr-2"></i> 解析地址
            </button>
            <button 
                id="templateBtn" 
                class="px-6 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-all flex items-center"
            >
                <i class="fa fa-file-text mr-2"></i> 输入模板
            </button>
            <button 
                id="clearBtn" 
                class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all flex items-center"
            >
                <i class="fa fa-trash mr-2"></i> 清空输入
            </button>
        </div>
    </section>

    <!-- 播放区域 -->
    <section id="playerContainer" class="bg-white rounded-xl shadow-lg p-4 mb-4 mx-2 hidden relative overflow-hidden" style="height: calc(100vh - 300px);">
        <button 
            id="closePlayerBtn" 
            class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition-colors z-10"
        >
            <i class="fa fa-times text-xl"></i>
        </button>
        <h2 class="text-lg font-semibold mb-3 flex items-center">
            <i class="fa fa-play-circle text-primary mr-2"></i> 正在播放
        </h2>
        <div class="bg-black rounded-lg mb-3 overflow-hidden" style="height: 80%;">
            <div id="videoPlayer" class="rounded-lg overflow-hidden" style="position: relative; width: 100%; height: 100%;">
                <video
                    id="videoElement"
                    class="video-js vjs-default-skin"
                    controls
                    preload="auto"
                    style="width: 100%; height: 100%;"
                    data-setup="{}"
                >
                    <p class="vjs-no-js">
                        您的浏览器不支持视频播放，请 
                        <a href="https://videojs.com/html5-video-support/" target="_blank">升级浏览器</a>。
                    </p>
                </video>
            </div>
        </div>
        <div class="flex flex-wrap gap-3">
            <button 
                id="saveProgressBtn" 
                class="px-6 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-all flex items-center"
                disabled
            >
                <i class="fa fa-save mr-2"></i> 保存进度
            </button>
            <button 
                id="screenshotBtn" 
                class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all flex items-center"
                disabled
            >
                <i class="fa fa-camera mr-2"></i> 截图
            </button>
            <button 
                id="downloadScreenshotBtn" 
                class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all flex items-center hidden"
            >
                <i class="fa fa-download mr-2"></i> 下载截图
            </button>
        </div>
        <div id="screenshotContainer" class="mt-4 hidden">
            <h3 class="font-medium mb-2">截图预览</h3>
            <div class="bg-gray-100 rounded-lg p-4">
                <img id="screenshotImage" class="max-w-full rounded" alt="视频截图">
            </div>
        </div>
    </section>

    <!-- 视频列表区域 -->
    <section class="mb-4 mx-8">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fa fa-th-large text-primary mr-2"></i> 我的视频列表
        </h2>
        <div id="videoList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- 视频卡片将在这里动态生成 -->
            <div class="text-center text-gray-500 py-12 col-span-full">
                <i class="fa fa-film text-5xl mb-4 opacity-30"></i>
                <p>暂无视频，请添加视频</p>
            </div>
        </div>
    </section>

    <!-- 确认对话框 -->
    <div id="confirmDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4" id="dialogTitle">确认删除</h3>
            <p class="mb-6 text-gray-600" id="dialogMessage">你确定要删除这个视频吗？此操作不可撤销。</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDialog" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">
                    取消
                </button>
                <button id="confirmDialogBtn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all">
                    确认删除
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentVideo = null;
        let currentEpisode = null;
        let videoToDelete = null;
        let videoPlayer = null; // Video.js 播放器实例
        let hlsInstance = null; // HLS.js 实例
        let hasJumpedToProgress = false; // 防止重复跳转标志

        // DOM 加载完成后执行
        document.addEventListener('DOMContentLoaded', () => {
            // 从 localStorage 加载保存的视频
            loadVideos();

            // 绑定事件监听器
            document.getElementById('showInputBtn').addEventListener('click', showInputSection);
            document.getElementById('closeInputBtn').addEventListener('click', hideInputSection);
            document.getElementById('parseBtn').addEventListener('click', parseVideoUrls);
            document.getElementById('templateBtn').addEventListener('click', insertTemplate);
            document.getElementById('clearBtn').addEventListener('click', clearInput);
            document.getElementById('screenshotBtn').addEventListener('click', takeScreenshot);
            document.getElementById('downloadScreenshotBtn').addEventListener('click', downloadScreenshot);
            document.getElementById('cancelDialog').addEventListener('click', hideConfirmDialog);
            document.getElementById('confirmDialogBtn').addEventListener('click', confirmDeleteVideo);
            document.getElementById('closePlayerBtn').addEventListener('click', hidePlayerSection);
            document.getElementById('saveProgressBtn').addEventListener('click', saveProgressManually);
        });

        // 显示粘贴视频地址区域
        function showInputSection() {
            const inputSection = document.getElementById('inputSection');
            inputSection.classList.remove('hidden');
            document.getElementById('videoUrls').focus();
        }

        // 隐藏粘贴视频地址区域
        function hideInputSection() {
            const inputSection = document.getElementById('inputSection');
            inputSection.classList.add('hidden');
        }

        // 隐藏播放区域
        function hidePlayerSection() {
            const playerContainer = document.getElementById('playerContainer');
            playerContainer.classList.add('hidden');
            
            // 销毁HLS实例
            if (hlsInstance) {
                try {
                    hlsInstance.destroy();
                } catch (e) {
                    console.error('销毁HLS实例失败:', e);
                }
                hlsInstance = null;
            }
            
            // 销毁Video.js播放器实例
            if (videoPlayer) {
                try {
                    videoPlayer.dispose();
                } catch (e) {
                    console.error('销毁播放器失败:', e);
                }
                videoPlayer = null;
            }
            
            // 重置video元素
            const videoElement = document.getElementById('videoElement');
            if (videoElement) {
                videoElement.src = '';
                videoElement.load();
            }
            
            // 禁用按钮
            document.getElementById('screenshotBtn').disabled = true;
            document.getElementById('saveProgressBtn').disabled = true;
            
            // 隐藏下载截图按钮
            document.getElementById('downloadScreenshotBtn').classList.add('hidden');
        }

        // 解析视频地址
        async function parseVideoUrls() {
            const input = document.getElementById('videoUrls').value.trim();
            if (!input) {
                showToast('请输入视频地址', 'error');
                return;
            }

            try {
                showToast('正在解析并验证视频地址...', 'info');
                const videoData = parseVideoData(input);
                
                // 验证所有视频URL是否可访问
                const checkResults = await Promise.allSettled(
                    videoData.episodes.map(episode => checkVideoUrl(episode.url))
                );
                
                // 统计验证结果
                let successCount = 0;
                let failedUrls = [];
                
                checkResults.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value.accessible) {
                        successCount++;
                    } else {
                        failedUrls.push({
                            title: videoData.episodes[index].title,
                            url: videoData.episodes[index].url
                        });
                    }
                });
                
                // 如果有部分URL无法访问，给出警告但仍然保存
                if (failedUrls.length > 0 && successCount > 0) {
                    showToast(`解析完成，${successCount}个视频可访问，${failedUrls.length}个视频可能无法播放`, 'warning');
                    console.warn('无法访问的视频:', failedUrls);
                } else if (failedUrls.length === videoData.episodes.length) {
                    showToast('警告：所有视频URL都可能无法访问，但已保存到列表', 'warning');
                } else {
                    showToast('视频已成功添加，所有链接验证通过', 'success');
                }
                
                saveVideo(videoData);
                loadVideos();
                hideInputSection();
                clearInput();
            } catch (error) {
                showToast('解析失败: ' + error.message, 'error');
            }
        }
        
        // 检查视频URL是否可访问
        async function checkVideoUrl(url) {
            try {
                const response = await fetch('/check-video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('检查视频URL失败:', error);
                return { accessible: false, error: error.message };
            }
        }

        // 解析视频数据
        function parseVideoData(input) {
            const lines = input.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) {
                throw new Error('输入格式不正确，至少需要视频名称和一个视频地址');
            }

            const title = lines[0].trim();
            const episodes = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                // 使用正则表达式匹配 <b>标签内容</b>URL 的格式
                const regex = /<b>(.*?)<\/b>(.*)/;
                const match = line.match(regex);
                
                if (match && match.length === 3) {
                    const episodeTitle = match[1].trim();
                    const url = match[2].trim();
                    
                    if (isValidUrl(url)) {
                        episodes.push({
                            id: `ep${i}`,
                            title: episodeTitle,
                            url: url
                        });
                    } else {
                        throw new Error(`第 ${i} 行的URL格式不正确: ${url}`);
                    }
                } else {
                    throw new Error(`第 ${i} 行格式不正确，应符合 <b>集数</b>URL 格式`);
                }
            }

            if (episodes.length === 0) {
                throw new Error('未找到有效的视频地址');
            }

            return {
                id: generateId(),
                title: title,
                episodes: episodes
            };
        }

        // 验证URL格式
        function isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch (error) {
                return false;
            }
        }

        // 生成唯一ID
        function generateId() {
            return 'vid_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
        }

        // 保存单个视频到localStorage
        function saveVideo(videoData) {
            const savedVideos = JSON.parse(localStorage.getItem('videoPlaylists') || '[]');
            savedVideos.push(videoData);
            localStorage.setItem('videoPlaylists', JSON.stringify(savedVideos));
        }

        // 从localStorage加载视频数据
        function loadVideos() {
            const savedVideos = localStorage.getItem('videoPlaylists');
            
            if (savedVideos) {
                try {
                    const videos = JSON.parse(savedVideos);
                    const videoList = document.getElementById('videoList');
                    videoList.innerHTML = '';
                    
                    if (videos.length > 0) {
                        videos.forEach(video => {
                            const videoCard = createVideoCard(video);
                            videoList.appendChild(videoCard);
                        });
                    } else {
                        videoList.innerHTML = `
                            <div class="text-center text-gray-500 py-12 col-span-full">
                                <i class="fa fa-film text-5xl mb-4 opacity-30"></i>
                                <p>暂无视频，请添加视频</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('加载视频列表失败:', error);
                    localStorage.removeItem('videoPlaylists');
                }
            }
        }

        // 创建视频卡片
        function createVideoCard(videoData) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg overflow-hidden card-shadow card-hover';
            card.dataset.videoId = videoData.id;

            card.innerHTML = `
                <div class="p-5 relative">
                    <button class="delete-video absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors" title="删除视频">
                        <i class="fa fa-times-circle text-xl"></i>
                    </button>
                    <h3 class="font-bold text-lg mb-3 truncate">${escapeHTML(videoData.title)}</h3>
                    <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                        <div class="flex items-center">
                            <i class="fa fa-film mr-2"></i>
                            <span>${videoData.episodes.length} 集</span>
                        </div>
                        <div class="text-xs text-primary" id="latest-progress-${videoData.id}">
                            ${getLatestProgressDisplay(videoData)}
                        </div>
                    </div>
                    <button class="toggle-episodes w-full py-2 px-4 bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200 transition-all flex justify-center items-center">
                        <span>查看全部剧集</span>
                        <i class="fa fa-chevron-down ml-2 transition-transform duration-300"></i>
                    </button>
                    <div class="episodes-container mt-4 hidden">
                        <div class="grid grid-cols-2 gap-2">
                            ${videoData.episodes.map(episode => {
                                const progress = getSavedProgress(videoData.id, episode.id);
                                const progressDisplay = progress > 0 ? ` (已观看 ${formatTime(progress)})` : '';
                                return `
                                    <div class="flex gap-1">
                                        <button 
                                            class="play-episode flex-1 py-2 px-3 bg-primary/10 text-primary rounded hover:bg-primary/20 transition-all text-sm truncate relative group"
                                            data-episode-id="${episode.id}"
                                            data-url="${episode.url}"
                                        >
                                            ${escapeHTML(episode.title)}${progressDisplay}
                                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-20">
                                                ${escapeHTML(episode.title)}${progressDisplay}
                                            </div>
                                        </button>
                                        <button class="copy-url px-2 py-2 text-gray-400 hover:text-primary transition-colors relative group" title="复制链接" data-url="${episode.url}">
                                            <i class="fa fa-link"></i>
                                            <div class="absolute bottom-full right-0 mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-10">
                                                ${episode.url.length > 40 ? episode.url.substring(0, 40) + '...' : episode.url}
                                            </div>
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;

            // 绑定展开/折叠事件
            const toggleBtn = card.querySelector('.toggle-episodes');
            const episodesContainer = card.querySelector('.episodes-container');
            const chevron = toggleBtn.querySelector('.fa-chevron-down');

            toggleBtn.addEventListener('click', () => {
                episodesContainer.classList.toggle('hidden');
                chevron.style.transform = episodesContainer.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
            });

            // 绑定播放事件
            const playButtons = card.querySelectorAll('.play-episode');
            playButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const episodeId = e.currentTarget.dataset.episodeId;
                    const episode = videoData.episodes.find(ep => ep.id === episodeId);
                    if (episode) {
                        playVideo(videoData.id, videoData.title, episode);
                    }
                });
            });

            // 绑定复制链接事件
            const copyButtons = card.querySelectorAll('.copy-url');
            copyButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const url = e.currentTarget.dataset.url;
                    copyToClipboard(url);
                    e.stopPropagation(); // 防止触发播放事件
                });
            });

            // 绑定删除事件
            const deleteBtn = card.querySelector('.delete-video');
            deleteBtn.addEventListener('click', (e) => {
                videoToDelete = videoData.id;
                showConfirmDialog(`确定要删除《${videoData.title}》吗？`, '确认删除');
                e.stopPropagation(); // 防止触发展开/折叠事件
            });

            return card;
        }

        // 转义HTML特殊字符
        function escapeHTML(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // 播放视频
        function playVideo(videoId, videoTitle, episode) {
            currentVideo = { id: videoId, title: videoTitle };
            currentEpisode = episode;
            
            // 显示播放区域
            const playerContainer = document.getElementById('playerContainer');
            playerContainer.classList.remove('hidden');
            
            // 更新标题
            document.title = `${episode.title} - Video Space`;
            
            // 启用按钮
            document.getElementById('screenshotBtn').disabled = false;
            document.getElementById('saveProgressBtn').disabled = false;
            
            // 先尝试内嵌播放
            tryIframePlay(episode.url);
        }
        
        // 显示HLS错误对话框
        function showHLSErrorDialog(episode, error) {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4">
                    <h3 class="text-xl font-bold mb-4 text-red-600">
                        <i class="fa fa-exclamation-triangle mr-2"></i>HLS流播放错误
                    </h3>
                    <div class="mb-4 p-4 bg-red-50 rounded-lg">
                        <p class="text-sm text-gray-700 mb-2"><strong>错误类型：</strong> ${error.errorType || 'HLS解析错误'}</p>
                        <p class="text-sm text-gray-700 mb-2"><strong>错误代码：</strong> ${error.errorCode || 'unknown'}</p>
                        ${error.errorDetails ? `<p class="text-sm text-gray-700 mb-2"><strong>详细信息：</strong> ${error.errorDetails}</p>` : ''}
                        <p class="text-sm text-gray-700 mb-2"><strong>错误信息：</strong> ${error.message || 'HLS流无法正常解析'}</p>
                        ${error.url ? `<p class="text-sm text-gray-700"><strong>失败URL：</strong> <span class="text-xs break-all">${error.url}</span></p>` : ''}
                    </div>
                    <p class="mb-4 text-gray-600">这是一个HLS流媒体文件（.m3u8），可能存在以下问题：</p>
                    <ul class="text-sm text-gray-600 mb-4 list-disc list-inside space-y-1">
                        <li>视频源服务器有访问限制</li>
                        <li>HLS流格式不兼容或已损坏</li>
                        <li>需要特殊的播放器支持</li>
                        <li>网络连接问题</li>
                    </ul>
                    <div class="space-y-3">
                        <button onclick="tryDirectHLSPlay('${episode.url}')" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center">
                            <i class="fa fa-refresh mr-2"></i> 尝试直连播放
                        </button>
                        <button onclick="openInNewTab('${episode.url}')" class="w-full px-4 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all flex items-center justify-center">
                            <i class="fa fa-external-link mr-2"></i> 在新标签页中打开
                        </button>
                        <button onclick="copyVideoUrl('${episode.url}')" class="w-full px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all flex items-center justify-center">
                            <i class="fa fa-copy mr-2"></i> 复制原始链接
                        </button>
                    </div>
                    <div class="mt-4 pt-4 border-t">
                        <button onclick="closePlayOptions()" class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            dialog.id = 'playOptionsDialog';
            document.body.appendChild(dialog);
        }
        
        // 尝试直连HLS播放（不通过代理）
        function tryDirectHLSPlay(url) {
            try {
                closePlayOptions();
                
                // 清理之前的播放器实例
                cleanupPlayer();
                
                // 重置跳转标志位
                hasJumpedToProgress = false;
                
                // 获取保存的播放进度
                const savedProgress = getSavedProgress(currentVideo.id, currentEpisode.id);
                
                showToast('正在尝试直连HLS播放...', 'info');
                
                // 获取video元素
                const videoElement = document.getElementById('videoElement');
                
                // 直接使用原始URL，不通过代理
                if (Hls.isSupported()) {
                    // 使用hls.js直连（不使用代理）
                    hlsInstance = new Hls({
                        enableWorker: true,
                        lowLatencyMode: false,
                        backBufferLength: 90,
                        maxBufferLength: 30,
                        maxMaxBufferLength: 600,
                        liveSyncDurationCount: 3,
                        xhrSetup: function(xhr, url) {
                            // 添加跨域请求头
                            xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
                        }
                    });
                    
                    hlsInstance.loadSource(url);
                    hlsInstance.attachMedia(videoElement);
                    
                    hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
                        showToast('直连HLS流解析成功！', 'success');
                        setupVideoEvents(videoElement, savedProgress);
                    });
                    
                    hlsInstance.on(Hls.Events.ERROR, (event, data) => {
                        console.error('直连HLS错误:', data);
                        
                        if (data.fatal) {
                            showToast('直连播放失败，请尝试其他播放方式', 'error');
                            showPlayOptions(currentEpisode);
                        }
                    });
                } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                    // Safari原生支持
                    videoElement.src = url;
                    showToast('使用原生HLS直连播放', 'info');
                    setupVideoEvents(videoElement, savedProgress);
                } else {
                    // 降级到Video.js直连
                    const options = {
                        controls: true,
                        responsive: true,
                        fluid: false,
                        fill: true,
                        preload: 'auto',
                        sources: [{
                            src: url,
                            type: 'application/x-mpegURL'
                        }],
                        html5: {
                            vhs: {
                                overrideNative: !videojs.browser.IS_SAFARI
                            }
                        }
                    };
                    
                    if (videoElement.player) {
                        videoElement.player.dispose();
                    }
                    
                    videoPlayer = videojs(videoElement, options, function() {
                        showToast('Video.js直连播放器初始化成功', 'success');
                        setupVideoJSEvents(this, savedProgress);
                    });
                    
                    videoPlayer.on('error', (e) => {
                        const error = videoPlayer.error();
                        console.error('Video.js直连错误:', error);
                        showToast('直连播放失败，请尝试其他播放方式', 'error');
                        showPlayOptions(currentEpisode);
                    });
                }
                
            } catch (error) {
                console.error('创建直连播放器失败:', error);
                showToast('无法创建播放器，请尝试其他方式', 'error');
                showPlayOptions(currentEpisode);
            }
        }
        
        // 显示播放选项
        function showPlayOptions(episode) {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">选择播放方式</h3>
                    <p class="mb-4 text-gray-600">由于视频服务器限制，请选择合适的播放方式：</p>
                    <div class="space-y-3">
                        <button onclick="openInNewTab('${episode.url}')" class="w-full px-4 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all flex items-center justify-center">
                            <i class="fa fa-external-link mr-2"></i> 在新标签页中打开
                        </button>
                        <button onclick="tryIframePlay('${episode.url}')" class="w-full px-4 py-3 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-all flex items-center justify-center">
                            <i class="fa fa-play mr-2"></i> 尝试内嵌播放
                        </button>
                        <button onclick="copyVideoUrl('${episode.url}')" class="w-full px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all flex items-center justify-center">
                            <i class="fa fa-copy mr-2"></i> 复制链接地址
                        </button>
                    </div>
                    <div class="mt-4 pt-4 border-t">
                        <button onclick="closePlayOptions()" class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">
                            取消
                        </button>
                    </div>
                </div>
            `;
            dialog.id = 'playOptionsDialog';
            document.body.appendChild(dialog);
        }
        
        // 在新标签页中打开
        function openInNewTab(url) {
            window.open(url, '_blank');
            closePlayOptions();
            showToast('已在新标签页中打开视频', 'success');
        }
        
        // 使用新播放器播放
        function tryIframePlay(url) {
            try {
                // 清理之前的播放器实例
                cleanupPlayer();
                
                // 重置跳转标志位
                hasJumpedToProgress = false;
                
                // 获取保存的播放进度
                const savedProgress = getSavedProgress(currentVideo.id, currentEpisode.id);
                
                // 检查是否为HLS流
                const isHLS = url.toLowerCase().includes('.m3u8');
                
                // 使用代理服务器的URL来避免跨域问题
                const proxyUrl = `/proxy/video?url=${encodeURIComponent(url)}`;
                
                showToast('正在初始化播放器...', 'info');
                
                // 获取video元素
                const videoElement = document.getElementById('videoElement');
                
                if (isHLS) {
                    // 对于HLS流，优先使用hls.js
                    if (Hls.isSupported()) {
                        initHLSPlayer(proxyUrl, videoElement, savedProgress);
                    } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                        // Safari原生支持HLS
                        initNativeHLSPlayer(proxyUrl, videoElement, savedProgress);
                    } else {
                        // 降级到Video.js
                        initVideoJSPlayer(proxyUrl, videoElement, savedProgress, true);
                    }
                } else {
                    // 普通视频文件使用Video.js
                    initVideoJSPlayer(proxyUrl, videoElement, savedProgress, false);
                }
                
                closePlayOptions();
                
            } catch (error) {
                console.error('创建播放器失败:', error);
                showPlayOptions(currentEpisode);
            }
        }
        
        // 清理播放器
        function cleanupPlayer() {
            // 销毁HLS实例
            if (hlsInstance) {
                try {
                    hlsInstance.destroy();
                } catch (e) {
                    console.error('销毁HLS实例失败:', e);
                }
                hlsInstance = null;
            }
            
            // 销毁Video.js播放器实例
            if (videoPlayer) {
                try {
                    videoPlayer.dispose();
                } catch (e) {
                    console.error('销毁播放器失败:', e);
                }
                videoPlayer = null;
            }
        }
        
        // 初始化HLS.js播放器（使用服务器端URL重写）
        function initHLSPlayer(url, videoElement, savedProgress) {
            console.log('初始化HLS播放器，URL:', url);
            
            // 使用优化的HLS.js配置
            hlsInstance = new Hls({
                enableWorker: true,
                lowLatencyMode: false,
                backBufferLength: 90,
                maxBufferLength: 30,
                maxMaxBufferLength: 600,
                liveSyncDurationCount: 3,
                // 关键：增加重试配置
                manifestLoadingTimeOut: 10000,
                manifestLoadingMaxRetry: 3,
                manifestLoadingRetryDelay: 1000,
                levelLoadingTimeOut: 10000,
                levelLoadingMaxRetry: 3,
                levelLoadingRetryDelay: 1000,
                fragLoadingTimeOut: 20000,
                fragLoadingMaxRetry: 6,
                fragLoadingRetryDelay: 1000,
                // 调试配置
                debug: false,
                enableSoftwareAES: true,
                capLevelToPlayerSize: false,
                startPosition: -1
            });
            
            hlsInstance.loadSource(url);
            hlsInstance.attachMedia(videoElement);
            
            // 监听所有重要事件
            hlsInstance.on(Hls.Events.MANIFEST_LOADING, (event, data) => {
                console.log('HLS清单开始加载:', data.url);
                showToast('正在加载HLS清单...', 'info');
            });
            
            hlsInstance.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                console.log('HLS清单解析成功');
                console.log('可用质量级别:', data.levels.map(level => ({
                    width: level.width,
                    height: level.height,
                    bitrate: level.bitrate
                })));
                showToast('HLS流解析成功，开始播放', 'success');
                setupVideoEvents(videoElement, savedProgress);
            });
            
            hlsInstance.on(Hls.Events.LEVEL_LOADING, (event, data) => {
                console.log('HLS子级别开始加载:', data.url);
            });
            
            hlsInstance.on(Hls.Events.LEVEL_LOADED, (event, data) => {
                console.log('HLS子级别加载完成:', data.url, '片段数量:', data.details?.fragments?.length || 0);
                if (data.details?.fragments?.length > 0) {
                    console.log('首个片段URL:', data.details.fragments[0]?.url);
                    showToast(`子级别加载成功，包含 ${data.details.fragments.length} 个片段`, 'success');
                } else {
                    console.warn('子级别加载完成但没有片段');
                    showToast('警告：子级别没有找到视频片段', 'warning');
                }
            });
            
            hlsInstance.on(Hls.Events.FRAG_LOADING, (event, data) => {
                console.log('片段开始加载:', data.frag?.url);
            });
            
            hlsInstance.on(Hls.Events.FRAG_LOADED, (event, data) => {
                console.log('片段加载成功:', data.frag?.url, '大小:', data.payload?.byteLength);
            });
            
            hlsInstance.on(Hls.Events.FRAG_PARSED, (event, data) => {
                console.log('片段解析完成:', data.frag?.url);
            });
            
            hlsInstance.on(Hls.Events.FRAG_BUFFERED, (event, data) => {
                console.log('片段缓冲完成:', data.frag?.url);
            });
            
            hlsInstance.on(Hls.Events.ERROR, (event, data) => {
                console.error('HLS错误:', data);
                
                if (data.fatal) {
                    let errorMessage = '';
                    let shouldShowDialog = false;
                    
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            errorMessage = '网络错误，尝试恢复...';
                            if (data.details === 'manifestLoadError') {
                                console.log('清单文件加载失败，可能是代理问题');
                                errorMessage = 'HLS清单文件加载失败';
                                shouldShowDialog = true;
                            } else if (data.details === 'levelLoadError') {
                                console.log('子清单加载失败');
                                errorMessage = 'HLS子清单文件加载失败';
                                shouldShowDialog = true;
                            } else if (data.details === 'fragLoadError') {
                                console.log('片段加载失败，尝试恢复');
                                errorMessage = '视频片段加载失败，尝试恢复...';
                                showToast(errorMessage, 'warning');
                                
                                // 尝试恢复片段加载错误
                                setTimeout(() => {
                                    if (hlsInstance) {
                                        hlsInstance.startLoad();
                                    }
                                }, 1000);
                                return;
                            }
                            
                            if (shouldShowDialog) {
                                showHLSErrorDialog(currentEpisode, {
                                    errorType: data.type,
                                    errorCode: data.code,
                                    errorDetails: data.details,
                                    message: data.reason || data.details || errorMessage,
                                    url: data.url
                                });
                            } else {
                                showToast(errorMessage, 'warning');
                                
                                // 尝试恢复网络错误
                                setTimeout(() => {
                                    if (hlsInstance) {
                                        hlsInstance.startLoad();
                                    }
                                }, 1000);
                            }
                            break;
                            
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            errorMessage = '媒体错误，尝试恢复...';
                            showToast(errorMessage, 'warning');
                            
                            // 尝试恢复媒体错误
                            setTimeout(() => {
                                if (hlsInstance) {
                                    hlsInstance.recoverMediaError();
                                }
                            }, 1000);
                            break;
                            
                        default:
                            shouldShowDialog = true;
                            break;
                    }
                    
                    // 如果是代理相关错误，尝试直连播放
                    if ((data.details === 'manifestLoadError' || data.details === 'levelLoadError') && 
                        data.url && data.url.includes('/proxy/')) {
                        console.log('代理加载失败，尝试直连播放');
                        showToast('代理加载失败，正在尝试直连播放...', 'warning');
                        // 从代理URL中提取原始URL
                        const urlMatch = data.url.match(/\/proxy\/video\?url=([^&]+)/);
                        if (urlMatch) {
                            const originalUrl = decodeURIComponent(urlMatch[1]);
                            setTimeout(() => {
                                tryDirectHLSPlay(originalUrl);
                            }, 1000);
                            return;
                        }
                    }
                    
                    // 如果多次恢复失败，显示错误对话框
                    if (shouldShowDialog || data.details === 'levelLoadTimeOut' || data.details === 'fragLoadTimeOut') {
                        showHLSErrorDialog(currentEpisode, {
                            errorType: data.type,
                            errorCode: data.code,
                            errorDetails: data.details,
                            message: data.reason || data.details || 'HLS播放失败',
                            url: data.url
                        });
                    }
                } else {
                    // 非致命错误，记录但继续播放
                    console.warn('HLS非致命错误:', data);
                }
            });
            
            // 监听缓冲状态
            hlsInstance.on(Hls.Events.BUFFER_APPENDING, () => {
                console.log('开始添加数据到缓冲区');
            });
            
            hlsInstance.on(Hls.Events.BUFFER_APPENDED, () => {
                console.log('数据已添加到缓冲区');
            });
            
            // 监听首帧渲染
            hlsInstance.on(Hls.Events.INIT_PTS_FOUND, () => {
                console.log('找到初始时间戳，即将开始播放');
                showToast('视频即将开始播放...', 'info');
            });
        }
        
        // 初始化原生HLS播放器 (Safari)
        function initNativeHLSPlayer(url, videoElement, savedProgress) {
            videoElement.src = url;
            showToast('使用原生HLS播放', 'info');
            setupVideoEvents(videoElement, savedProgress);
        }
        
        // 初始化Video.js播放器
        function initVideoJSPlayer(url, videoElement, savedProgress, isHLS) {
            const options = {
                controls: true,
                responsive: true,
                fluid: false,
                fill: true,
                preload: 'auto',
                sources: [{
                    src: url,
                    type: isHLS ? 'application/x-mpegURL' : 'video/mp4'
                }],
                html5: {
                    vhs: {
                        overrideNative: !videojs.browser.IS_SAFARI
                    }
                }
            };
            
            // 确保之前的实例被清理
            if (videoElement.player) {
                videoElement.player.dispose();
            }
            
            videoPlayer = videojs(videoElement, options, function() {
                showToast('Video.js播放器初始化成功', 'success');
                setupVideoJSEvents(this, savedProgress);
            });
            
            videoPlayer.on('error', (e) => {
                const error = videoPlayer.error();
                console.error('Video.js错误:', error);
                
                if (isHLS) {
                    showHLSErrorDialog(currentEpisode, {
                        errorType: 'Video.js',
                        errorCode: error ? error.code : 'unknown',
                        message: error ? error.message : '播放失败'
                    });
                } else {
                    showPlayOptions(currentEpisode);
                }
            });
        }
        
        // 设置原生video事件
        function setupVideoEvents(videoElement, savedProgress) {
            videoElement.addEventListener('loadstart', () => {
                showToast('开始加载视频...', 'info');
            });
            
            videoElement.addEventListener('canplay', () => {
                showToast('视频加载完成，可以播放', 'success');
                
                // 跳转到保存的进度
                if (savedProgress > 0 && !hasJumpedToProgress) {
                    hasJumpedToProgress = true;
                    videoElement.currentTime = savedProgress;
                    showToast(`已跳转到上次播放位置: ${formatTime(savedProgress)}`, 'info');
                }
            });
            
            videoElement.addEventListener('timeupdate', () => {
                if (currentVideo && currentEpisode && videoElement.currentTime > 0) {
                    // 每30秒保存一次进度
                    const currentTime = Math.floor(videoElement.currentTime);
                    if (currentTime % 30 === 0) {
                        saveProgress(currentVideo.id, currentEpisode.id, currentTime);
                    }
                }
            });
            
            videoElement.addEventListener('error', (e) => {
                console.error('Video元素错误:', e);
                showPlayOptions(currentEpisode);
            });
        }
        
        // 设置Video.js事件
        function setupVideoJSEvents(player, savedProgress) {
            player.on('loadstart', () => {
                showToast('开始加载视频...', 'info');
            });
            
            player.on('canplay', () => {
                showToast('视频加载完成，可以播放', 'success');
                
                // 跳转到保存的进度
                if (savedProgress > 0 && !hasJumpedToProgress) {
                    hasJumpedToProgress = true;
                    player.currentTime(savedProgress);
                    showToast(`已跳转到上次播放位置: ${formatTime(savedProgress)}`, 'info');
                }
            });
            
            player.on('timeupdate', () => {
                if (currentVideo && currentEpisode && player.currentTime() > 0) {
                    // 每30秒保存一次进度
                    const currentTime = Math.floor(player.currentTime());
                    if (currentTime % 30 === 0) {
                        saveProgress(currentVideo.id, currentEpisode.id, currentTime);
                    }
                }
            });
        }
        
        // 通用复制到剪贴板函数
        function copyToClipboard(text) {
            // 检查是否支持现代剪贴板API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('链接已复制到剪贴板', 'success');
                }).catch(err => {
                    console.error('复制失败:', err);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                // 使用fallback方法
                fallbackCopyTextToClipboard(text);
            }
        }
        
        // fallback复制方法
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            
            // 避免滚动到底部
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('链接已复制到剪贴板', 'success');
                } else {
                    showToast('复制失败，请手动复制', 'error');
                }
            } catch (err) {
                console.error('复制失败:', err);
                showToast('复制失败，请手动复制', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        // 复制视频链接
        function copyVideoUrl(url) {
            copyToClipboard(url);
            closePlayOptions();
        }
        
        // 关闭播放选项对话框
        function closePlayOptions() {
            const dialog = document.getElementById('playOptionsDialog');
            if (dialog) {
                document.body.removeChild(dialog);
            }
        }

        // 手动保存播放进度
        function saveProgressManually() {
            if (!currentVideo || !currentEpisode) {
                showToast('请先播放视频', 'warning');
                return;
            }
            
            let currentTime = 0;
            let success = false;
            
            try {
                // 尝试从Video.js播放器获取时间
                if (videoPlayer && typeof videoPlayer.currentTime === 'function') {
                    currentTime = videoPlayer.currentTime();
                    if (!isNaN(currentTime) && currentTime > 0) {
                        success = true;
                    }
                }
                
                // 如果Video.js失败，尝试从原生video元素获取
                if (!success) {
                    const videoElement = document.getElementById('videoElement');
                    if (videoElement && !isNaN(videoElement.currentTime) && videoElement.currentTime > 0) {
                        currentTime = videoElement.currentTime;
                        success = true;
                    }
                }
                
                if (success) {
                    saveProgress(currentVideo.id, currentEpisode.id, currentTime);
                    showToast(`进度已保存: ${formatTime(currentTime)}`, 'success');
                    return;
                }
                
                // 如果都无法获取播放时间，显示时间选择器
                showTimeSelector();
                
            } catch (e) {
                console.error('获取播放时间失败:', e);
                showTimeSelector();
            }
        }
        
        // 显示时间选择器
        function showTimeSelector() {
            // 创建时间选择器对话框
            const dialog = document.createElement('div');
            dialog.id = 'timeSelectorDialog';
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            dialog.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4 text-center">设置播放进度</h3>
                    <div class="flex items-center justify-center space-x-2 mb-6">
                        <div class="text-center">
                            <label class="block text-sm text-gray-600 mb-1">时</label>
                            <input type="number" id="hours" min="0" max="23" value="0" 
                                   class="w-16 px-2 py-1 border rounded text-center">
                        </div>
                        <span class="text-xl font-bold mt-6">:</span>
                        <div class="text-center">
                            <label class="block text-sm text-gray-600 mb-1">分</label>
                            <input type="number" id="minutes" min="0" max="59" value="0" 
                                   class="w-16 px-2 py-1 border rounded text-center">
                        </div>
                        <span class="text-xl font-bold mt-6">:</span>
                        <div class="text-center">
                            <label class="block text-sm text-gray-600 mb-1">秒</label>
                            <input type="number" id="seconds" min="0" max="59" value="0" 
                                   class="w-16 px-2 py-1 border rounded text-center">
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="cancelTimeSelector()" 
                                class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all">
                            取消
                        </button>
                        <button onclick="confirmTimeSelector()" 
                                class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-all">
                            确认保存
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            // 自动聚焦到分钟输入框
            setTimeout(() => {
                document.getElementById('minutes').focus();
            }, 100);
        }
        
        // 取消时间选择器
        function cancelTimeSelector() {
            const dialog = document.getElementById('timeSelectorDialog');
            if (dialog) {
                document.body.removeChild(dialog);
            }
        }
        
        // 确认时间选择器
        function confirmTimeSelector() {
            const hours = parseInt(document.getElementById('hours').value) || 0;
            const minutes = parseInt(document.getElementById('minutes').value) || 0;
            const seconds = parseInt(document.getElementById('seconds').value) || 0;
            
            // 验证输入值
            if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59 || seconds < 0 || seconds > 59) {
                showToast('请输入有效的时间值', 'error');
                return;
            }
            
            // 转换为总秒数
            const totalSeconds = hours * 3600 + minutes * 60 + seconds;
            
            if (totalSeconds === 0) {
                showToast('请设置一个有效的时间', 'warning');
                return;
            }
            
            // 保存进度
            saveProgress(currentVideo.id, currentEpisode.id, totalSeconds);
            showToast(`进度已保存: ${formatTime(totalSeconds)}`, 'success');
            
            // 关闭对话框
            cancelTimeSelector();
        }

        // 截图
        function takeScreenshot() {
            if (!currentVideo || !currentEpisode) {
                showToast('请先播放视频', 'warning');
                return;
            }
            
            const videoElement = document.getElementById('videoElement');
            if (!videoElement) {
                showToast('请先播放视频', 'warning');
                return;
            }
            
            try {
                // 直接使用canvas截图方案
                fallbackCanvasScreenshot();
            } catch (e) {
                console.error('截图失败:', e);
                showToast('截图失败，请稍后重试', 'error');
            }
        }
        
        // 备选canvas截图方案
        function fallbackCanvasScreenshot() {
            const video = document.getElementById('videoElement');
            if (video) {
                
                // 检查视频是否可以截图（避免跨域问题）
                if (video.crossOrigin !== 'anonymous' && video.src && !video.src.startsWith(window.location.origin)) {
                    showToast('由于跨域限制，无法截图此视频源', 'warning');
                    return;
                }
                
                // 创建canvas来截取视频帧
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 360;
                
                try {
                    // 检查canvas是否被污染
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // 尝试获取图像数据，如果canvas被污染会抛出SecurityError
                    const dataURL = canvas.toDataURL('image/png');
                    
                    // 显示下载按钮
                    const downloadBtn = document.getElementById('downloadScreenshotBtn');
                    downloadBtn.dataset.screenshot = dataURL;
                    downloadBtn.classList.remove('hidden');
                    
                    showToast('截图成功，点击下载按钮保存', 'success');
                } catch (e) {
                    console.error('截图失败:', e);
                    if (e.name === 'SecurityError') {
                        showToast('由于安全限制，无法截图跨域视频。请尝试使用播放器自带的截图功能', 'warning');
                    } else {
                        showToast('截图失败，请稍后重试', 'error');
                    }
                }
            } else {
                showToast('无法获取视频元素，截图失败', 'error');
            }
        }

        // 下载截图
        function downloadScreenshot() {
            const screenshotData = document.getElementById('downloadScreenshotBtn').dataset.screenshot;
            if (!screenshotData) return;
            
            const link = document.createElement('a');
            link.href = screenshotData;
            link.download = `${currentEpisode.title}_截图.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('截图已下载', 'success');
        }

        // 保存播放进度
        function saveProgress(videoId, episodeId, progress) {
            const savedProgress = JSON.parse(localStorage.getItem('videoProgress') || '{}');
            const key = `${videoId}_${episodeId}`;
            savedProgress[key] = progress;
            localStorage.setItem('videoProgress', JSON.stringify(savedProgress));
            
            // 刷新DOM显示
            refreshProgressDisplay(videoId, episodeId, progress);
        }
        
        // 获取最新观看进度显示
        function getLatestProgressDisplay(videoData) {
            let latestProgress = 0;
            let latestEpisode = null;
            
            videoData.episodes.forEach(episode => {
                const progress = getSavedProgress(videoData.id, episode.id);
                if (progress > latestProgress) {
                    latestProgress = progress;
                    latestEpisode = episode;
                }
            });
            
            if (latestProgress > 0 && latestEpisode) {
                return `最近观看: ${latestEpisode.title} (${formatTime(latestProgress)})`;
            }
            return '';
        }
        
        // 刷新进度显示
        function refreshProgressDisplay(videoId, episodeId, progress) {
            // 更新特定视频卡片的进度显示
            const progressElement = document.getElementById(`latest-progress-${videoId}`);
            if (progressElement) {
                const videoData = JSON.parse(localStorage.getItem('videoPlaylists') || '[]')
                    .find(video => video.id === videoId);
                if (videoData) {
                    progressElement.textContent = getLatestProgressDisplay(videoData);
                }
            }
            
            // 重新加载视频列表以更新所有进度显示
            loadVideos();
        }

        // 获取保存的播放进度
        function getSavedProgress(videoId, episodeId) {
            const savedProgress = JSON.parse(localStorage.getItem('videoProgress') || '{}');
            const key = `${videoId}_${episodeId}`;
            return savedProgress[key] || 0;
        }

        // 清除保存的播放进度
        function clearSavedProgress(videoId, episodeId) {
            const savedProgress = JSON.parse(localStorage.getItem('videoProgress') || '{}');
            const key = `${videoId}_${episodeId}`;
            if (savedProgress[key]) {
                delete savedProgress[key];
                localStorage.setItem('videoProgress', JSON.stringify(savedProgress));
            }
        }

        // 插入模板
        function insertTemplate() {
            const template = `示例电视剧名称
<b>第01集</b>https://example.com/video1.mp4
<b>第02集</b>https://example.com/video2.mp4
<b>第03集</b>https://example.com/video3.mp4`;
            document.getElementById('videoUrls').value = template;
            showToast('模板已插入，请修改为实际内容', 'success');
        }

        // 清空输入
        function clearInput() {
            document.getElementById('videoUrls').value = '';
        }

        // 删除视频
        function deleteVideo(videoId) {
            const savedVideos = JSON.parse(localStorage.getItem('videoPlaylists') || '[]');
            const updatedVideos = savedVideos.filter(video => video.id !== videoId);
            localStorage.setItem('videoPlaylists', JSON.stringify(updatedVideos));
            
            // 清除该视频的所有播放进度
            const savedProgress = JSON.parse(localStorage.getItem('videoProgress') || '{}');
            Object.keys(savedProgress).forEach(key => {
                if (key.startsWith(videoId)) {
                    delete savedProgress[key];
                }
            });
            localStorage.setItem('videoProgress', JSON.stringify(savedProgress));
            
            loadVideos();
            showToast('视频已删除', 'success');
        }

        // 显示确认对话框
        function showConfirmDialog(message, title = '确认操作') {
            document.getElementById('dialogTitle').textContent = title;
            document.getElementById('dialogMessage').textContent = message;
            document.getElementById('confirmDialog').classList.remove('hidden');
        }

        // 隐藏确认对话框
        function hideConfirmDialog() {
            document.getElementById('confirmDialog').classList.add('hidden');
            videoToDelete = null;
        }

        // 确认删除视频
        function confirmDeleteVideo() {
            if (videoToDelete) {
                deleteVideo(videoToDelete);
                hideConfirmDialog();
            }
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            // 计算当前已存在的toast数量，避免重叠
            const existingToasts = document.querySelectorAll('.toast-message');
            const topOffset = 16 + (existingToasts.length * 80); // 每个toast高度约64px + 16px间距
            
            // 创建toast元素
            const toast = document.createElement('div');
            toast.className = `toast-message fixed right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                type === 'warning' ? 'bg-yellow-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            toast.style.top = `${topOffset}px`;
            toast.textContent = message;
            
            // 添加到body
            document.body.appendChild(toast);
            
            // 显示动画
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
                toast.classList.add('translate-x-0');
            }, 10);
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.remove('translate-x-0');
                toast.classList.add('translate-x-full');
                
                // 动画结束后移除元素
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // 格式化时间
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}小时${minutes}分${secs}秒`;
            } else if (minutes > 0) {
                return `${minutes}分${secs}秒`;
            } else {
                return `${secs}秒`;
            }
        }
    </script>
</body>
</html>
    